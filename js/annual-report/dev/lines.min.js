var Ctrl,c;function import$(t,e){var a,n={}.hasOwnProperty;for(a in e)n.call(e,a)&&(t[a]=e[a]);return t}function in$(t,e){for(var a=-1,n=e.length>>>0;++a<n;)if(t===e[a])return!0;return!1}(Ctrl=function(t){var e=this,t=(this.opt=t=null==t?{}:t).root;return this.root=t="string"==typeof t?document.querySelector(t):t||null,this.svg=ld$.find(t,"svg",0),this.scale={},this.render=debounce(100,function(t){return e._render(t)}),this.popup=debounce(500,function(){return e._popup()}),this.highlight=debounce(1e3,function(){return e._highlight()}),this.mode="value",this.bipolar=!1,this}).prototype=import$(Object.create(Object.prototype),{setCattype:function(t){var e;return this.data=this.dataset[t],this.cattype=t,this.valtypes=function(){var t=[];for(e in this.data.attr)t.push(e);return t}.call(this).map(function(t){return{value:t}}),this.years=this.data.label.map(function(t){return+t}),this.activeCategories=null,this.setValtype(in$(this.valtype,this.valtypes.map(function(t){return t.value}))?this.valtype:this.valtypes[0].value),this.setValtype(in$(this.valtypeAlt,this.valtypes.map(function(t){return t.value}))?this.valtypeAlt:"年份",!0),this.render()},setValtype:function(t,e){var a,n,r;for(r in e?(a=[t,this.data.attr[t]],this.valtypeAlt=a[0],this.valuesAlt=a[1],this.bipolar="年份"!==t):(a=[t,this.data.attr[t]],this.valtype=a[0],this.values=a[1]),n=[],this.values)n.push(r);if(this.categories=n,!this.activeCategories){for(r in n=[],this.values)n.push(r);this.activeCategories=n}return this.render()},prepareView:function(){var a,n=this;return this.ldcv={},this.view=a=new ldView({initRender:!1,root:this.root,init:{ldcv:function(t){t=t.node;return n.ldcv[t.getAttribute("data-name")]=new ldCover({root:t})}},action:{change:{valtypes:function(t){var e=t.node;t.evt;return n.setValtype(e.value,!!e.getAttribute("data-alt"))},cattypes:function(t){var e=t.node;t.evt;return n.setCattype(e.value)}},click:{"toggle-ldcv":function(t){t=t.node;return n.ldcv[t.getAttribute("data-name")].toggle(!0)},mode:function(t){t=t.node;return n.mode=t.getAttribute("data-name"),"rank"===n.mode&&"年份"!==n.valtypeAlt&&n.ldcv["no-rank"].toggle(!0),"proportion"===n.mode&&"年份"!==n.valtypeAlt&&n.ldcv["no-proportion"].toggle(!0),n.render()}}},text:{year:function(){return n.active?n.active.year:""},value:function(){return n.active?n.active.value:""},valname:function(){return n.valtype},catname:function(){return n.active?n.active.catname:"n/a"}},handler:{mode:function(t){var e=t.node,t=e.getAttribute("data-name");return e.classList.toggle("active",t===n.mode),e.classList.toggle("disabled","value"!==t&&"年份"!==n.valtypeAlt)},cattypes:function(t){return t.node.value=n.cattype},valtypes:function(t){t=t.node;return t.value=t.getAttribute("data-alt")?n.valtypeAlt:n.valtype},cattype:{key:function(t){return t.value},list:function(){return n.cattypes||[]},handler:function(t){var e=t.node,t=t.data;return e.innerText=t.value,e.setAttribute("value",t.value),a.get("cattypes").value=n.cattype}},valtype:{key:function(t){return t.value},list:function(t){return(t.node.getAttribute("data-alt")?[{value:"年份"}]:[]).concat(n.valtypes||[])},handler:function(t){var e=t.node,t=t.data;return e.innerText=t.value,e.setAttribute("value",t.value),e.parentNode.value=e.getAttribute("data-alt")?n.valtypeAlt:n.valtype}}}})},init:function(){var a=this;return ld$.fetch("assets/data/annual-report/all.json",{method:"GET"},{type:"json"}).then(function(t){var e;return a.prepareView(),a.dataset=t,a.cattypes=function(){var t=[];for(e in this.dataset)t.push(e);return t}.call(a).map(function(t){return{value:t}}),a.setCattype(a.cattypes[0].value),a.setValtype(a.valtypes[0].value),a.prepare()})},_popup:function(){var t,e;if(this.active)return t=this.scale.x(this.active.x),e="proportion"===this.mode?this.scale.py(this.active.percent.offset+this.active.percent.delta/2):this.scale.y(this.active.y),import$(this.view.get("popup").style,{top:e+"px",left:t+(this.bipolar?0:this.scale.x.bandwidth()/2)+"px",opacity:1}),this.view.render(["year","value","value-alt","catname"]),this.highlight()},_highlight:function(){return this.render({highlight:!0})},prepare:function(){var l=this;return d3.select("svg").on("mouseout",function(){return l.popup().cancel(),l.highlight().cancel(),l.render()}),d3.select("svg").on("mousemove",function(){var t,e,a,n,r,i,s=d3.mouse(l.svg);if(l.scale.x){if(l.view.get("popup").style.opacity=0,t=l.scale.x.range(),e=s[0]-t[0],"proportion"===l.mode){if(e=l.scale.x.domain()[Math.floor(e/l.scale.x.bandwidth())],a=l.scale.py.invert(s[1]),!l.bands||!(n=l.bands.filter(function(t){return t.year===e})[0]))return;r=n.pts.filter(function(t){return!isNaN(t.value)}),i=d3.minIndex(r,function(t){return Math.abs(t.percent.offset+t.percent.delta/2-a)}),l.active=n.pts[i]||{}}else if(l.bipolar)i=d3.minIndex(l.ptsValid,function(t){return Math.pow(l.scale.x(t.x)-s[0],2)+Math.pow(l.scale.y(t.y)-s[1],2)}),l.active=l.ptsValid[i]||{};else{if(e=l.scale.x.domain()[Math.floor(e/l.scale.x.bandwidth())],a=l.scale.y.invert(s[1]),!l.bands||!(n=l.bands.filter(function(t){return t.year===e})[0]))return;r=n.pts.filter(function(t){return!isNaN(t.value)}),i=d3.minIndex(r,function(t){return Math.abs(t.y-a)}),l.active=n.pts[i]||{}}return d3.select(l.svg).selectAll("circle").transition("mouse-hover").duration(50).attr("r",function(t,e){return l.active&&t.key===l.active.key?10:5}),d3.select(l.svg).selectAll("path.line").transition("mouse-hover").duration(50).attr("stroke-width",function(t,e){return l.active&&t.catname===l.active.catname?3:1}),l.popup()}})},_render:function(t){var e,a,n,r,i,s,l,o,c,u,d,h,p,f=this;for(n in null==t&&(t={}),this.view.render(),this.pts=e=[],a=[],"年份"!==this.valtypeAlt&&(this.mode="value",this.view.render(["mode"])),this.bands=this.years.map(function(t){return{year:t,pts:[]}}),r=this.values)if(i=r[n],"合計"!==n)for(a.push(s={catname:n,pts:[]}),l=0,o=this.years.length;l<o;++l)c=l,in$(n,this.activeCategories||[])&&(e.push(c={key:this.years[c]+"-"+n,valtype:this.valtype,catname:n,year:this.years[c],raw:i[c],value:+i[c],rawAlt:(this.valuesAlt?this.valuesAlt[n]:this.years)[c],valueAlt:this.valuesAlt?+this.valuesAlt[n][c]:this.years[c],x:this.valuesAlt?+this.valuesAlt[n][c]:this.years[c],y:+i[c]}),s.pts.push(c));return e.map(function(e){return f.bands.filter(function(t){return t.year===e.year})[0].pts.push(e)}),this.bands.map(function(t){for(var e,a,n,r,i=[],s=0,l=0,o=t.pts.length;l<o;++l)a=l,e=t.pts[a],a=isNaN(+e.y)?0:+e.y,e.percent={offset:s,delta:a},s+=a;for(l=0,r=(n=t.pts).length;l<r;++l)(e=n[l]).percent.offset=e.percent.offset/s,i.push(e.percent.delta=e.percent.delta/s);return i}),"rank"===this.mode&&this.bands.map(function(t,e){t=[].concat(t.pts.filter(function(t){return!isNaN(t.value)}));return t.sort(function(t,e){return e.value-t.value}),t.map(function(t,e){return t.y=e+1})}),this.ptsValid=u=e.filter(function(t){return!(isNaN(t.value)||isNaN(t.valueAlt))}).filter(function(t){return"合計"!==t.catname}),i=u.map(function(t){return t.y}),h=u.map(function(t){return t.x}),p=this.categories.map(function(t,e){var a=e/f.categories.length;return ldColor.hex({h:360*a,c:30+70*a,l:40+50*(e%4/3)})}),t.highlight&&this.active&&(p=this.categories.map(function(t,e){var a=e/f.categories.length;return t===f.active.catname?ldColor.hex({h:360*a,c:30+70*a,l:40+50*(e%4/3)}):"#ccc"})),this.box=this.svg.getBoundingClientRect(),this.margin=20,this.scale.x=this.bipolar?d3.scaleLinear().domain("value"===this.mode?[Math.min.apply(Math,h),Math.max.apply(Math,h)]:[Math.max.apply(Math,h),Math.min.apply(Math,h)]):d3.scaleBand().domain(this.years),import$(this.scale,{color:d3.scaleOrdinal().domain(this.categories.concat(["反向選取","全選"])).range(p.concat(["#fff","#fff"])),py:d3.scaleLinear().domain([1,0]).range([this.box.height-this.margin-30+10,this.margin-10]),y:d3.scaleLinear().domain("value"===this.mode?[Math.min.apply(Math,i),Math.max.apply(Math,i)]:[Math.max.apply(Math,i),Math.min.apply(Math,i)]).range([this.box.height-this.margin-30,this.margin])}),t=d3.legendColor().shape("path",d3.symbol().type(d3.symbolCircle).size(100)()).shapePadding(5).scale(this.scale.color),(h=d3.select("svg").selectAll("g.legend").data([this.cattype],function(t){return t})).exit().remove(),h.enter().append("g").attr("class","legend text-sm").call(t),p=ld$.find(this.root,"g.legend",0),h=this.box.width-p.getBoundingClientRect().width-20,p.setAttribute("transform","translate("+h+", 32)"),this.scale.x.range([this.margin+40,h-this.margin]),d3.select("svg g.legend").selectAll("g.cell").style("cursor","pointer").on("click",function(t){var e,a=f.activeCategories||[];return"反向選取"===t?a=f.activeCategories=f.categories.filter(function(t){return!in$(t,a)}):"全選"===t?f.activeCategories=[].concat(f.categories):in$(t,a)&&~(e=a.indexOf(t))?a.splice(e,1):a.push(t),f.render()}).transition().duration(350).attr("opacity",function(t,e){return"反向選取"===t||"全選"===t||in$(t,f.activeCategories||[])?1:.3}),(t=d3.select(this.svg).select("g.bands").selectAll("rect.band").data(this.bipolar?[]:this.years,function(t){return t})).exit().remove(),t.enter().append("rect").attr("class","band"),d3.select(this.svg).selectAll("rect.band").attr("x",function(t){return f.scale.x(t)}).attr("width",function(){return f.scale.x.bandwidth()}).attr("y",function(){return 0}).attr("height",function(){return f.box.height}).attr("fill","#def").attr("fill-opacity","0").on("mouseover",function(){return d3.select(this).transition().duration(150).attr("fill-opacity",1)}).on("mouseout",function(){return d3.select(this).transition().duration(150).attr("fill-opacity",0)}),d=d3.format("~s"),p=d3.axisBottom(this.scale.x).tickFormat(function(t){return 3e3<=t?d(t):t}),h=d3.axisLeft("proportion"===this.mode?this.scale.py:this.scale.y).tickFormat(function(t){return 3e3<=t?d(t):t}),(t=d3.select("svg").selectAll("g.axis-x").data([1],function(t){return t})).exit().remove(),t.enter().append("g").attr("class","axis-x").call(p),d3.select("svg").selectAll("g.axis-x").attr("transform","translate(0,"+(this.box.height-30)+")").transition().duration(350).call(p),(p=d3.select("svg").selectAll("g.axis-y").data([1],function(t){return t})).exit().remove(),p.enter().append("g").attr("class","axis-y").call(h),d3.select("svg").selectAll("g.axis-y").attr("transform","translate(50,0)").transition().duration(350).call(h),s=d3.line().defined(function(t){return!isNaN(t.value)&&!isNaN(t.valueAlt)}).x(function(t){return f.scale.x(t.x)+(f.bipolar?0:f.scale.x.bandwidth()/2)}).y(function(t){return f.scale.y(t.y)}),p=function(t,e){return t=(e?t:t.transition().duration(350)).filter(function(t,e){return!t.deleted}).attr("d",function(t){return s(t.pts)}).attr("fill","none").attr("class",function(t,e){return f.bipolar&&f.active&&t.catname===f.active.catname?"line highlight":"line"}).attr("stroke",function(t){return f.scale.color(t.catname)}).attr("stroke-width",function(t,e){return f.active&&t.catname===f.active.catname?3:1}).attr("stroke-dasharray",function(t,e){return f.bipolar&&f.active&&t.catname===f.active.catname?"5 5":"1 0"}).attr("opacity",0),(e?t.transition().duration(350):t).filter(function(t,e){return!t.deleted}).attr("opacity",function(){return"proportion"===f.mode?0:1})},(h=d3.select(this.svg).selectAll("path.line").data(a,function(t){return t.catname})).exit().each(function(t,e){return t.deleted=!0}).transition().duration(350).attr("opacity",0).remove(),p(h.enter().append("path"),!0),p(d3.select(this.svg).selectAll("path.line").filter(function(t){return!t.deleted})),p=function(t,e){return t=(e?t:t.transition().duration(350)).filter(function(t,e){return!t.deleted}).attr("cx",function(t){return f.scale.x(t.x)+(f.bipolar?0:f.scale.x.bandwidth()/2)}).attr("cy",function(t){return"proportion"===f.mode?f.scale.py(t.percent.offset+t.percent.delta/2):f.scale.y(t.y)}).attr("r",function(t){return f.active&&t.key===f.active.key?10:5}).attr("fill",function(t){return f.scale.color(t.catname)}).attr("opacity",0),(e?t.transition().duration(350):t).filter(function(t,e){return!t.deleted}).attr("opacity",function(){return"proportion"===f.mode?0:1})},(h=d3.select(this.svg).selectAll("circle").data(u,function(t){return t.key})).exit().each(function(t,e){return t.deleted=!0}).transition().duration(350).attr("opacity",0).remove(),p(h.enter().append("circle"),!0),p(d3.select(this.svg).selectAll("circle").filter(function(t){return!t.deleted})),p=function(t,e){return t=(e?t:t.transition().duration(350)).attr("class","stack").attr("x",function(t){return f.scale.x(t.x)}).attr("y",function(t){return f.scale.py(t.percent.offset+t.percent.delta/2)}).attr("height",0).attr("width",function(){return f.bipolar?0:f.scale.x.bandwidth()}).attr("fill",function(t){return f.scale.color(t.catname)}).attr("opacity",0),(e?t.transition().duration(350):t).filter(function(t,e){return!t.deleted}).attr("y",function(t){return"proportion"!==f.mode?f.scale.py(t.percent.offset+t.percent.delta/2):f.scale.py(t.percent.offset)}).attr("height",function(t){return"proportion"!==f.mode?0:Math.abs(f.scale.py(t.percent.offset+t.percent.delta)-f.scale.py(t.percent.offset))}).attr("opacity",1)},(h=d3.select(this.svg).selectAll("rect.stack").data(u,function(t){return t.key})).exit().each(function(t,e){return t.deleted=!0}).transition().duration(350).attr("opacity",0).remove(),p(h.enter().append("rect").attr("class","stack"),!0),p(d3.select(this.svg).selectAll("rect.stack").filter(function(t){return!t.deleted}))}}),(c=new Ctrl({root:document.body})).init();