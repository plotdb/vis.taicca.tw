ld$.fetch("/assets/data/annual-report/industry.json",{method:"GET"},{type:"json"}).then(function(l){var t,e,n,r,a,i,u,c,o,s,d,f,h,p,m,g,v=svg.getBoundingClientRect(),y=10,M=l.label.map(function(t){return+t}),N=[];for(t in e=l.attr)for(r in n=e[t])for(a=n[r],i=0,u=M.length;i<u;++i)c=i,N.push({type:t,cat:r,year:M[c],value:+a[c]});return p=M.map(function(e){return N.filter(function(t){return t.year===e&&"外銷收入占比"===t.type})}),o=[],p.map(function(t){for(var e,n=0,r=0,a=t.length;r<a;++r)e=r,isNaN(t[e].value)||(n+=t[e].value),t[e].sum=n;for(r=0,a=t.length;r<a;++r)t[e=r].percent=t[e].value/n,t[e].sum=t[e].sum/n;return o=o.concat(t)}),s=function(){var t=[];for(d in l.attr["外銷收入占比"])t.push(d);return t}().map(function(n){for(var t,e=M.map(function(t,e){return[t,+l.attr["外銷收入占比"][n][e],0,0]}),r=0,a=0,i=e.length;a<i;++a)r+=e[t=a][1],e[t][3]=r;for(a=0,i=e.length;a<i;++a)e[t=a][2]=e[t][1]/r,e[t][3]=e[t][3]/r;return e}),d3.scaleLinear().domain([0,s.length-1]).range([y,v.width-y]),f=d3.scaleBand().domain(M).range([y,v.width-y]),d3.scaleLinear().domain([Math.min.apply(Math,M),Math.max.apply(Math,M)]).range([y,v.width-y]),h=Math.min.apply(Math,s.map(function(t){return Math.min.apply(Math,t.map(function(t){return t[1]}).filter(function(t){return!isNaN(t)}))})),p=Math.max.apply(Math,s.map(function(t){return Math.max.apply(Math,t.map(function(t){return t[1]}).filter(function(t){return!isNaN(t)}))})),m=d3.scaleLinear().domain([h,p]).range([v.height-y,y]),g=d3.scaleLinear().domain([0,1]).range([y,v.height-y]),v=d3.line().curve(d3.curveCardinal).defined(function(t){return!isNaN(t[1])}).x(function(t){return f(t[0])+f.bandwidth()/2}).y(function(t){return m(t[1])}),(y=d3.select("svg").selectAll("path").data(s)).enter().append("path").attr("d",v).attr("stroke","#000").attr("stroke-width","1").attr("fill","none"),y.exit().remove(),d3.select("svg").selectAll("g").data(s).enter().append("g"),d3.select("svg").selectAll("g").each(function(t,e){return d3.select(this).selectAll("circle").data(t.filter(function(t){return!isNaN(t[1])})).enter().append("circle"),d3.select(this).selectAll("circle").attr("cx",function(t){return f(t[0])+f.bandwidth()/2}).attr("cy",function(t){return m(t[1])}).attr("r",3).attr("fill","#fff").attr("stroke","black").attr("stroke-width",1)}),d3.select("svg").selectAll("rect").data(o.filter(function(t){return!isNaN(t.value)})).enter().append("rect"),d3.select("svg").selectAll("rect").attr("x",function(t){return f(t.year)}).attr("y",function(t){return g(t.sum-t.percent)}).attr("width",function(t){return f.bandwidth()}).attr("height",function(t){return g(t.sum)-g(t.sum-t.percent)}).attr("fill",function(t,e){return d3.interpolateSpectral((t.year-2008)/10)}).attr("fill-opacity",.5).attr("stroke","#000").attr("stroke-width",1)});