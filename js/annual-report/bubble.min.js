function import$(t,e){var n,i={}.hasOwnProperty;for(n in e)i.call(e,n)&&(t[n]=e[n]);return t}subchart.bubble=function(t){return this.host=(t=null==t?{}:t).host,this.svg=t.svg,this.aniloop=t.aniloop,this.timeline=t.timeline,this},subchart.bubble.prototype=import$(import$(Object.create(Object.prototype),subchart.interface),{timeDelta:0,scale:{},hide:function(){return this.svg.classList.toggle("d-none",!0)},prepare:function(){var t,n,i,e,s=this;if(this.sim=null,this.svg.classList.toggle("d-none",!1),this.box=this.svg.getBoundingClientRect(),this.popup=debounce(350,function(t){return s._popup(t)}),this.values=(e=this.host).values,this.years=e.years,this.valtypes=e.valtypes,this.categories=e.categories,e=(t=[this.timeline,this.aniloop])[0],(t=t[1]).setObj(this),e.set({years:this.years,svg:this.svg}),t.reset(),e=function(){var t,e=[];for(n in t=this.values)i=t[n],e.push([n,i]);return e}.call(this).filter(function(t){return!("合計"===t[0])}).map(function(t){return t[1].map(function(t){return+t}).filter(function(t){return!isNaN(t)})}),Math.min.apply(Math,e.map(function(t){return Math.min.apply(Math,t)})),e=Math.max.apply(Math,e.map(function(t){return Math.max.apply(Math,t)})),this.textLen=Math.max.apply(Math,this.categories.map(function(t){return t.length})),this.data=this.categories.filter(function(t){return!("合計"===t)}).map(function(t,e){return{key:t,val:0}}),this.dh=(this.box.height-80)/this.data.length,this.scale=d3.scaleLinear().domain([0,Math.sqrt(e)]).range([2,100]),this.host.active)return t.setTime(1e3*(this.host.active.year-this.years[0]),!0),t.pause(),t.render()},delta:function(t){var e,i=this,t=t/1e3,s=Math.floor(t),r=t-s;return s%=10,this.data.map(function(t,e){var n=+i.values[t.key][s],t=+i.values[t.key][(1+s)%i.years.length];return n=isNaN(n)?0:n,t=isNaN(t)?0:t,i.data[e].val=(t-n)*r+n}),this.data.sort(function(t,e){return e.val>t.val?1:e.val<t.val?-1:0}),e={},this.data.map(function(t){return e[t.key]=t}),this.data.map(function(t,e){if(t.idx!==e&&(null==t.odx&&(t.odx=e),t.idx=e),t.odx=.2*(t.idx-t.odx)+t.odx,t.r=i.scale(Math.sqrt(t.val)),t.x||(t.x=i.box.width/2),!t.y)return t.y=(i.box.height-40)/2}),this.sim||(this.fc=t=d3.forceCollide(),this.sim=d3.forceSimulation().force("x",this.fx=d3.forceX(this.box.width/2).strength(.1)).force("y",this.fy=d3.forceY((this.box.height-40)/2).strength(.1)).force("collide",t),this.sim.stop()),this.sim.nodes(this.data),this.fc.radius(function(t){return t.r+2}),this.sim.alpha(.6),this.sim.tick(200),this.fx.strength(.01),this.fy.strength(.01)},_popup:function(t){var e,n,i,s=this;return this.view||(this.view=new ldView({root:ld$.find("[ld-scope=perspective-popup]",0),context:t,handler:{popup:function(){},catname:function(t){var e=t.node,t=t.context;if(t)return e.innerText=t.key},unit:function(t){var e=t.node;t.context;return e.innerText=s.host.unit},valname:function(t){var e=t.node;t.context;return e.innerText=s.host.valtype},value:function(t){var e=t.node,t=t.context;if(t)return e.innerText=t.val}}})),e=this.view.get("popup"),t?(this.view.setContext(t),this.view.render(),i=(n=[t.x+this.box.x,t.y+this.box.y,t.r])[0],t=n[1],n[2],e.getBoundingClientRect(),import$(e.style,{left:i+"px",top:t+"px",opacity:1})):((n=e.style).opacity=0,n)},render:function(t){var e,n=this,i=this,s=d3.select(this.svg).selectAll("circle.bubble").data(this.data);return s.exit().remove(),s.enter().append("circle").attr("class","bubble").on("mouseover",function(t,e){return n.popup.clear(),n.popup(t)}).on("mouseout",function(t,e){return n.popup()}),d3.select(this.svg).selectAll("circle.bubble").attr("cx",function(t,e){return t.x}).attr("cy",function(t,e){return t.y}).attr("r",function(t,e){return 2<(t=t.r)?t:2}).attr("fill",function(t,e){return i.host.scale.color(t.key)}),(e=d3.select(this.svg).selectAll("g.label").data(this.data)).exit().remove(),e.enter().append("g").on("mouseover",function(t,e){return n.popup.clear(),n.popup(t)}).on("mouseout",function(t,e){return n.popup()}).attr("class","label").each(function(t,e){var n=this;return[0,1].map(function(){return d3.select(n).append("text")}).map(function(t){return t.attr("dy","-.28em").attr("text-anchor","middle").attr("font-size",".9em").style("pointer-event","none")})}),d3.select(this.svg).selectAll("g.label").attr("transform",function(t,e){return"translate("+t.x+","+t.y+")"}).each(function(n,t){return d3.select(this).selectAll("text").attr("opacity",2*n.r<5*(n.val.toFixed(2)+"").length?0:1).attr("dy",function(t,e){return 0===e?"-.28em":".88em"}).text(function(t,e){return 0===e?1e6<n.val?(n.val/1e6).toFixed(2)+"M":1e3<n.val?(n.val/1e3).toFixed(2)+"K":n.val.toFixed(2):n.key})}),s=d3.legendColor().shape("path",d3.symbol().type(d3.symbolCircle).size(100)()).shapePadding(5).scale(this.host.scale.color),(e=d3.select(this.svg).selectAll("g.legend").data([this.host.cattype],function(t){return t})).exit().remove(),e.enter().append("g").attr("class","legend text-sm").call(s),s=ld$.find(this.svg,"g.legend",0),d3.select(this.svg).selectAll("g.legend").selectAll(".cell").style("display",function(t,e){if("全不選"===t||"反向選取"===t||"全選"===t)return"none"}),s={x:this.box.width-cfg.margin-cfg.legendPl-s.getBoundingClientRect().width},d3.select(this.svg).selectAll("g.legend").attr("transform","translate("+s.x+", 24)"),this.chartInfo(t)}});