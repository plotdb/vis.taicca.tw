var Ctrl;function import$(t,e){var n,i={}.hasOwnProperty;for(n in e)i.call(e,n)&&(t[n]=e[n]);return t}function in$(t,e){for(var n=-1,i=e.length>>>0;++n<i;)if(t===e[n])return!0;return!1}(Ctrl=function(t){var e,n,i,r,a=this;return this.opt=t=null==t?{}:t,this.evtHandler={},e=t.root,this.root=e="string"==typeof e?document.querySelector(e):e||null,this.config={pal:{sort:"hue",sel:"all"}},i=(n=[window.innerWidth,window.innerHeight])[0],t=n[1],r=(n=i<1.5*t?[i,2*i/3]:[1.5*t,t])[0],n[1],ld$.find(e,"[ld=container]").map(function(t){return t.style.width=r+"px",t.classList.toggle("d-none",!1),t}),this.aniloop=aniloop.main,this.timeline=new timeline({aniloop:this.aniloop}),this.aniloop.setTimeline(this.timeline),this.svg={map:ld$.find(e,"[ld=svg-map]",0),bubble:ld$.find(e,"[ld=svg-bubble]",0),pie:ld$.find(e,"[ld=svg-pie]",0),bar:ld$.find(e,"[ld=svg-bar]",0),trend:ld$.find(e,"[ld=svg-trend]",0)},this.subchart={map:new subchart.map({host:this,svg:this.svg.map,timeline:this.timeline,aniloop:this.aniloop}),bar:new subchart.bar({host:this,svg:this.svg.bar,timeline:this.timeline,aniloop:this.aniloop}),bubble:new subchart.bubble({host:this,svg:this.svg.bubble,timeline:this.timeline,aniloop:this.aniloop}),pie:new subchart.pie({host:this,svg:this.svg.pie,timeline:this.timeline,aniloop:this.aniloop})},this.perspective=null,this.scale={},this.render=debounce(100,function(t){var n,i;return a.getColor(t),function(){var t,e=[];for(n in t=this.subchart)i=t[n],e.push({k:n,v:i});return e}.call(a).filter(function(t){return t.k!==a.perspective}).map(function(t){return t.v.hide()}),a.perspective?(a.view.render(),a.subchart[a.perspective].prepare()):a._render(t)}),this.popup=debounce(350,function(){return a._popup()}),this.unpopup=function(){return a.view.get("popup").style.opacity=0},this.highlight=debounce(350,function(){return a._highlight()}),this.mode="value",this.bipolar=!1,this}).prototype=import$(import$(Object.create(Object.prototype),renderInterface),{on:function(t,e){var n;return((n=this.evtHandler)[t]||(n[t]=[])).push(e)},fire:function(t){for(var e,n,i,r,a=[],s=[],l=1,o=arguments.length;l<o;++l)s.push(arguments[l]);for(e=s,l=0,i=(n=this.evtHandler[t]||[]).length;l<i;++l)r=n[l],a.push(r.apply(this,e));return a},getBipolar:function(){return this.bipolar},getMode:function(){return this.mode},setMode:function(e,t){var n=this;return null==t&&(t=!1),this.mode=e,"rank"===this.mode&&"年份"!==this.valtypeAlt&&(t?this.setValtype("年份",!0):this.ldcv["no-rank"].get().then(function(t){if("reset"===t)return n.setMode(e,!0)})),"proportion"===this.mode&&"年份"!==this.valtypeAlt&&(t?this.setValtype("年份",!0):this.ldcv["no-proportion"].get().then(function(t){if("reset"===t)return n.setMode(e,!0)})),this.render().then(function(){return n.fire("mode-changed")})},setPerspective:function(t){return this.aniloop.pause(),this.perspective=t,this.render()},getYears:function(){return this.years},setYear:function(t){return this.activeYear=t,this.render()},getCattypes:function(){return this.cattypes},getCattype:function(){return this.cattype},getCategories:function(t){var e=this;return(t=null==t?{state:!0}:t).state?this.categories.map(function(t){return{name:t,active:in$(t,e.activeCategories||[])}}):this.categories},setCattype:function(t){var e,n,i=this;return this.data=this.dataset[t],this.cattype=t,this.valtypes=function(){var t=[];for(e in this.data.attr)t.push(e);return t}.call(this).map(function(t){return{value:t}}),this.years=this.data.label.map(function(t){return+t}),this.activeCategories=null,this.active=null,this.setValtype(in$(this.valtype,this.valtypes.map(function(t){return t.value}))?this.valtype:this.valtypes[0].value),this.setValtype(in$(this.valtypeAlt,this.valtypes.map(function(t){return t.value}))?this.valtypeAlt:"年份",!0),(n=this.view.getAll("perspective").filter(function(t){return"map"===t.getAttribute("data-name")})[0])&&n.classList.toggle("disabled","縣市"!==this.cattype),this.render().then(function(){return i.fire("cattype-changed",t)})},getValues:function(){return this.values},getValtypes:function(){return this.valtypes},getValtype:function(t){return(t=null==t?{alt:!1}:t).alt?this.valtypeAlt:this.valtype},setValtype:function(e,t){var n,i,r,a,s=this,l=(this.valtypes||[]).filter(function(t){return~t.value.indexOf(e)})[0];if(e=l?l.value:e,n={cur:this.bipolar,old:this.bipolar},t?(i=[e,(this.data.attr[e]||{}).data,(this.data.attr[e]||{}).unit],this.valtypeAlt=i[0],this.valuesAlt=i[1],this.unitAlt=i[2],n.cur=this.bipolar="年份"!==e,this.bipolar&&!this.config["connected-scatter-hint"]&&(this.ldcv["connected-scatter"].toggle(!0),this.config["connected-scatter-hint"]=!0)):(i=[e,(this.data.attr[e]||{}).data,(this.data.attr[e]||{}).unit],this.valtype=i[0],this.values=i[1],this.unit=i[2]),this.categories=function(){var t=[];for(r in this.values)t.push(r);return t}.call(this).filter(function(t){return!("合計"===t)}),!this.activeCategories){for(r in a=[],this.values)a.push(r);this.activeCategories=a}return this.render().then(function(){return n.cur!==n.old&&s.fire("bipolar-changed",s.bipolar),s.fire("valtype-changed")})},setActiveCategories:function(t){var e=this;return this.activeCategories=Array.isArray(t)?t:[t],this.render().then(function(){return e.fire("active-categories-changed")})},toggleActiveCategories:function(t){var i=this;return(t=Array.isArray(t)?t:[t]).map(function(t){var e,n=i.activeCategories||[];return"全不選"===t?n=i.activeCategories=[]:"反向選"===t?n=i.activeCategories=i.categories.filter(function(t){return!in$(t,n)}):"全選"===t?i.activeCategories=[].concat(i.categories):"配色"===t?i.ldcv["palette-pick"].get().then(function(){return i.render()}):in$(t,n)&&~(e=n.indexOf(t))?n.splice(e,1):n.push(t)}),this.render().then(function(){return i.fire("active-categories-changed")})},prepareView:function(){var n,d=this;return this.ldcv={},this.view=n=new ldView({initRender:!1,root:this.root,init:{ldcv:function(t){t=t.node;return d.ldcv[t.getAttribute("data-name")]=new ldcover({root:t})}},action:{change:{valtypes:function(t){var e=t.node;t.evt;return d.setValtype(e.value,!!e.getAttribute("data-alt"))},cattypes:function(t){var e=t.node;t.evt;return d.setCattype(e.value)}},click:{"set-pal":function(t){var e=t.node,t=e.getAttribute("data-type"),e=e.getAttribute("data-name");return d.config.pal[t]=e,d.view.render()},"single-year":function(){for(var t,e=+(d.view.get("single-year-chooser").value||2010),n=0,i=d.bands.length;n<i&&(t=n,d.bands[t].year!==e);++n);return d.active=(d.bands[t]||d.bands[0]).pts[0],d.ldcv.subchart.toggle(!0),d.setPerspective("bar")},perspective:function(t){t=t.node;return t.classList.contains("disabled")?d.ldcv["no-map"].toggle(!0):d.setPerspective(t.getAttribute("data-name"))},play:function(t){t.node;return("pie"===d.perspective?d.ldcv["no-animation"]:d.aniloop).toggle(!0)},pause:function(t){t.node;return"pie"===d.perspective?d.ldcv["no-animation"].toggle(!0):d.aniloop.toggle(!1)},close:function(t){t.node;return d.setPerspective(null)},download:function(t){var n,i,r,a,s,e,l,t=t.node,o={},c={url:"/assets/img/logo/watermark-sm.png",width:380,height:50},u={url:"/assets/img/qrcode-sm.png",width:50,height:50},h={padding:10};return h.height=2*h.padding+c.height,n=t.getAttribute("data-name"),i=[[""].concat(d.data.label)].concat(function(){var t,e=[];for(r in t=this.values)a=t[r],e.push([r,a]);return e}.call(d).map(function(t){var e=t[0],t=t[1];return[e].concat(t)})),csv4xls.toArray(i),s=csv4xls.toHref(i),e=d.svg[d.perspective||"trend"],l=e.getBoundingClientRect(),(e=e.cloneNode(!0)).setAttribute("xmlns","http://www.w3.org/2000/svg"),e.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),e.setAttribute("viewbox","0 0 "+l.width+" "+(l.height+h.height)),e.setAttribute("width",l.width+"px"),e.setAttribute("height",l.height+h.height+"px"),ldfile.fromURL(c.url,"dataurl").then(function(t){t=t.result;return o.logo=t,ldfile.fromURL(u.url,"dataurl")}).then(function(t){var t=t.result;return o.qrcode=t,t='<style type="text/css">\nsvg { background: #fff }\ntext { font-family: sans-serif; }\n.text-sm { font-size: .8em }\n</style>\n<image x="'+h.padding+'" y="'+(l.height+h.padding)+'"\nxlink:href="'+o.logo+'" width="'+c.width+'" height="'+c.height+'"/>\n<image x="'+(l.width-u.width-h.padding)+'" y="'+(l.height+h.padding)+'"\nxlink:href="'+o.qrcode+'" width="'+u.width+'" height="'+u.height+'"/>',t=e.outerHTML.replace("</svg>",t+"</svg>"),o.svgXml='<?xml version="1.0" encoding="utf-8"?>\n'+t,smiltool.svgToDataurl(t,l.width,l.height+h.height)}).then(function(t){return smiltool.urlToDataurl(t,l.width,l.height+h.height)}).then(function(t){return smiltool.dataurlToBlob(t)}).then(function(t){var e;switch(n){case"zip":return URL.createObjectURL(t),(e=new JSZip).file("result.csv",s.buffer),e.file("result.svg",o.svgXml),e.file("result.png",t),e.generateAsync({type:"blob"}).then(function(t){return{blob:t,name:"result.zip"}});case"csv":return{blob:csv4xls.toBlob(i),name:"result.csv"};case"png":return{blob:t,name:"result.png"};case"svg":return{blob:new Blob([o.svgXml],{type:"image/svg+xml"}),name:"result.svg"}}}).then(function(t){var e=t.blob,t=t.name;return ldfile.download({blob:e,name:t})})},"toggle-ldcv":function(t){t=t.node;return d.ldcv[t.getAttribute("data-name")].toggle(!0)},mode:function(t){t=t.node;return d.setMode(t.getAttribute("data-name"))}}},text:{year:function(){return d.active?d.active.year:""},value:function(){return d.active?d.active.value:""},valname:function(){return d.valtype},catname:function(){return d.active?d.active.catname:"n/a"}},handler:{player:function(t){return t.node.classList.toggle("disabled","pie"===d.perspective)},mode:function(t){var e=t.node,t=e.getAttribute("data-name");return e.classList.toggle("active",t===d.mode),e.classList.toggle("disabled","value"!==t&&"年份"!==d.valtypeAlt)},cattypes:function(t){return t.node.value=d.cattype},valtypes:function(t){t=t.node;return t.value=t.getAttribute("data-alt")?d.valtypeAlt:d.valtype},"set-pal":function(t){var e=t.node,n=e.getAttribute("data-type"),t=e.getAttribute("data-name");return e.classList.toggle("active",d.config.pal[n]===t)},cattype:{key:function(t){return t.value},list:function(){return d.cattypes||[]},handler:function(t){var e=t.node,t=t.data;return e.innerText=t.value,e.setAttribute("value",t.value),n.get("cattypes").value=d.cattype}},valtype:{key:function(t){return t.value},list:function(t){return(t.node.getAttribute("data-alt")?[{value:"年份"}]:[]).concat(d.valtypes||[])},handler:function(t){var e=t.node,t=t.data;return e.innerText=t.value,e.setAttribute("value",t.value),e.parentNode.value=e.getAttribute("data-alt")?d.valtypeAlt:d.valtype}}}})},init:function(t){var n=this,i=t.dataset;return Promise.resolve().then(function(){var e;return n.prepareView(),n.dataset=i,n.cattypes=function(){var t=[];for(e in this.dataset)t.push(e);return t}.call(n).map(function(t){return{value:t}}),n.setCattype("產業別"),n.setValtype("營業額"),n.prepare()})},_popup:function(){var t,e,n,i;if(this.active)return t=this.scale.x(this.active.x),e="proportion"===this.mode?this.scale.py(this.active.percent.offset+this.active.percent.delta/2):this.scale.y(this.active.y),import$((n=this.view.get("popup")).style,{left:t+(this.bipolar?0:this.scale.x.bandwidth()/2)+"px",opacity:1}),e<=this.box.height/2?((i=n.style).top=e+60+"px",i.bottom="auto"):((i=n.style).bottom=this.box.height-e+"px",i.top="auto"),this.view.render(["year","value","value-alt","catname"]),this.highlight()},_highlight:function(){return this.render({highlight:!0})},prepare:function(){var l=this;return d3.select(this.svg.trend).on("click",function(){return 1==+getComputedStyle(l.view.get("popup")).opacity?l.unpopup():ld$.parent(d3.event.target,".legend")||!ld$.parent(d3.event.target,".bands")&&!ld$.parent(d3.event.target,".stack")?void 0:(l.ldcv.subchart.toggle(!0),l.setPerspective("bar"))}),d3.select(this.svg.trend).on("mouseout",function(){return l.popup().cancel(),l.highlight().cancel(),l.render()}),d3.select(this.svg.trend).on("mousemove",function(){var t,e,n,i,r,a,s=d3.mouse(l.svg.trend);if(l.scale.x){if(l.view.get("popup").style.opacity=0,t=l.scale.x.range(),e=s[0]-t[0],"proportion"===l.mode){if(e=l.scale.x.domain()[Math.floor(e/l.scale.x.bandwidth())],n=l.scale.py.invert(s[1]),!l.bands||!(i=l.bands.filter(function(t){return t.year===e})[0]))return;r=i.pts.filter(function(t){return!isNaN(t.value)}),a=d3.minIndex(r,function(t){return Math.abs(t.percent.offset+t.percent.delta/2-n)}),l.active=i.pts[a]||{}}else if(l.bipolar)a=d3.minIndex(l.ptsValid,function(t){return Math.pow(l.scale.x(t.x)-s[0],2)+Math.pow(l.scale.y(t.y)-s[1],2)}),l.active=l.ptsValid[a]||{};else{if(e=l.scale.x.domain()[Math.floor(e/l.scale.x.bandwidth())],n=l.scale.y.invert(s[1]),!l.bands||!(i=l.bands.filter(function(t){return t.year===e})[0]))return;r=i.pts.filter(function(t){return!isNaN(t.value)}),a=d3.minIndex(r,function(t){return Math.abs(t.y-n)}),l.active=i.pts[a]||{}}return d3.select(l.svg.trend).selectAll("circle").transition("mouse-hover").duration(50).attr("r",function(t,e){return l.active&&t.key===l.active.key?10:5}),d3.select(l.svg.trend).selectAll("path.line").transition("mouse-hover").duration(50).attr("stroke-width",function(t,e){return l.active&&t.catname===l.active.catname?3:1}),l.popup()}})},getColor:function(r){var a,n,s=this,l={},o=(r=null==r?{}:r).highlight&&Array.isArray(r.highlight),c=r.highlight&&this.active,u=function(t,e,n,i){return o?in$(t,r.highlight)?h(e,n,i):"#eee":!c||t===s.active.catname?h(e,n,i):"#eee"},h=function(t,e,n){return ldColor.hex({h:20+320*t,c:70+30*e,l:45+45*n})},i="hue"===this.config.pal.sort?function(t,e,n){var i=t=n/t.length;return l[e]=u(e,i,t,n%4/3)}:"light"===this.config.pal.sort?function(t,e,n){var i;return t=i=(t.length-n)/t.length,l[e]=u(e,n%6/5,t,i)}:(a=(t=this.config.pal).order||(t.order=[]),function(i,t,e){var n;return a.length&&a.length===i.length||(a=s.config.pal.order=function(){for(var t=[],e=0,n=i.length;e<n;++e)t.push(e);return t}()).sort(function(){return 2*Math.random()-1}),e=a.indexOf(e),i=n=(i.length-e)/i.length,l[t]=u(t,e%6/5,i,n)}),t="all"===this.config.pal.sel?this.categories.map(function(t,e){return i(s.categories,t,e)}):((n=this.activeCategories.map(function(t){return t})).sort(function(t,e){return s.categories.indexOf(t)-s.categories.indexOf(e)}),n.map(function(t,e){return i(n,t,e)}),this.categories.filter(function(t,e){return!in$(t,s.activeCategories)}).map(function(t,e){return l[t]="#eee"}),this.categories.map(function(t){return l[t]}));return this.scale.color=d3.scaleOrdinal().domain(this.categories.concat(["全不選","全選","配色"])).range(t.concat(["#fff","#fff","#fff"]))},_render:function(t){var e,n,i,r,a,s,l,o,c,u,h,d,p,g,f=this;for(i in null==t&&(t={}),this.view.render(),this.pts=e=[],this.lines=n=[],"年份"!==this.valtypeAlt&&(this.mode="value",this.view.render(["mode"])),this.bands=this.years.map(function(t){return{year:t,pts:[]}}),r=this.values)if(a=r[i],"合計"!==i)for(n.push(s={catname:i,pts:[]}),l=0,o=this.years.length;l<o;++l)c=l,in$(i,this.activeCategories||[])&&(e.push(c={key:this.years[c]+"-"+i,valtype:this.valtype,catname:i,year:this.years[c],raw:a[c],value:+a[c],rawAlt:(this.valuesAlt?this.valuesAlt[i]:this.years)[c],valueAlt:this.valuesAlt?+this.valuesAlt[i][c]:this.years[c],x:this.valuesAlt?+this.valuesAlt[i][c]:this.years[c],y:+a[c]}),s.pts.push(c));return e.map(function(e){return f.bands.filter(function(t){return t.year===e.year})[0].pts.push(e)}),this.bands.map(function(t){for(var e,n,i,r,a=[],s=0,l=0,o=t.pts.length;l<o;++l)n=l,e=t.pts[n],n=isNaN(+e.y)?0:+e.y,e.percent={offset:s,delta:n},s+=n;for(l=0,r=(i=t.pts).length;l<r;++l)(e=i[l]).percent.offset=100*e.percent.offset/s,a.push(e.percent.delta=100*e.percent.delta/s);return a}),"rank"===this.mode&&this.bands.map(function(t,e){t=[].concat(t.pts.filter(function(t){return!isNaN(t.value)}));return t.sort(function(t,e){return e.value-t.value}),t.map(function(t,e){return t.y=e+1})}),this.ptsValid=d=e.filter(function(t){return!(isNaN(t.value)||isNaN(t.valueAlt))}).filter(function(t){return"合計"!==t.catname}),a=d.map(function(t){return t.y}),g=d.map(function(t){return t.x}),this.box=this.svg.trend.getBoundingClientRect(),this.scale.x=this.bipolar?d3.scaleLinear().domain("value"===this.mode?[Math.min.apply(Math,g),Math.max.apply(Math,g)]:[Math.max.apply(Math,g),Math.min.apply(Math,g)]):d3.scaleBand().domain(this.years),t=d3.legendColor().shape("path",d3.symbol().type(d3.symbolCircle).size(90)()).shapePadding(3).scale(this.scale.color),(d=d3.select(this.svg.trend).selectAll("g.legend").data([this.cattype],function(t){return t})).exit().remove(),d.enter().append("g").attr("class","legend text-sm").style("cursor","pointer").call(t).selectAll("g.cell").on("click",function(t){return f.toggleActiveCategories(t)}),d3.select(this.svg.trend).selectAll("g.legend").call(t),g=ld$.find(this.svg.trend,"g.legend",0),this.vp=u={x:cfg.yaxisWidth+cfg.yaxisPl+cfg.margin,y:cfg.margin,w:this.box.width-g.getBoundingClientRect().width-cfg.legendPl-2*cfg.margin-cfg.yaxisWidth-cfg.yaxisPl,h:this.box.height-2*cfg.margin-cfg.xaxisHeight-cfg.xaxisPb},import$(this.scale,{py:d3.scaleLinear().range([u.y+u.h,u.y]).domain([100,0]),y:d3.scaleLinear().range([u.y+u.h,u.y]).domain("value"===this.mode?[Math.min.apply(Math,a),Math.max.apply(Math,a)]:[Math.max.apply(Math,a),Math.min.apply(Math,a)])}),g.setAttribute("transform","translate("+(u.x+u.w+cfg.legendPl)+", 24)"),this.scale.x.range([u.x,u.x+u.w]),d3.select(this.svg.trend).select("g.legend").selectAll("g.cell").transition().duration(350).style("opacity",function(t,e){return"全不選"===t||"全選"===t||"配色"===t||in$(t,f.activeCategories||[])?1:.3}),(d=d3.select(this.svg.trend).select("g.bands").selectAll("rect.band").data(this.bipolar?[]:this.years,function(t){return t})).exit().remove(),d.enter().append("rect").attr("class","band"),d3.select(this.svg.trend).selectAll("rect.band").attr("x",function(t){return f.scale.x(t)}).attr("width",function(){return f.scale.x.bandwidth()}).attr("y",function(){return 0}).attr("height",function(){return f.box.height}).attr("fill","#def").attr("fill-opacity","0").on("mouseover",function(){return d3.select(this).transition().duration(150).attr("fill-opacity",1)}).on("mouseout",function(){return d3.select(this).transition().duration(150).attr("fill-opacity",0)}),h=d3.format("~s"),t=d3.axisBottom(this.scale.x).tickFormat(function(t){return 3e3<=t?h(t):t}),g=d3.axisLeft("proportion"===this.mode?this.scale.py:this.scale.y).tickFormat(function(t){return 3e3<=t?h(t):t}),(d=d3.select(this.svg.trend).selectAll("text.axis-x").data([1],function(t){return t})).exit().remove(),d.enter().append("text").attr("class","axis-x").attr("text-anchor","middle").attr("dy","-.5em").attr("font-size",".8em"),d3.select(this.svg.trend).selectAll("text.axis-x").attr("transform","translate("+(u.x+u.w/2)+", "+(this.box.height-cfg.xaxisPb/2)+")").text(this.valtypeAlt+(this.unitAlt?" ╱ 單位："+this.unitAlt:"")),(d=d3.select(this.svg.trend).selectAll("text.axis-y").data([1],function(t){return t})).exit().remove(),d.enter().append("text").attr("class","axis-y").attr("text-anchor","middle").attr("dominant-baseline","middle").attr("rotate","-90").attr("font-size",".8em"),d="proportion"===this.mode?"%":"rank"===this.mode?"排名︹由多到少︺":this.unit,d3.select(this.svg.trend).selectAll("text.axis-y").attr("transform","translate("+cfg.yaxisPl/2+", "+(20+u.y+u.h/2)+") rotate(90)").text(this.valtype+(d?"　╱　單位 ︰ "+d:"")),(d=d3.select(this.svg.trend).selectAll("g.axis-x").data([1],function(t){return t})).exit().remove(),d.enter().append("g").attr("class","axis-x").call(t),d3.select(this.svg.trend).selectAll("g.axis-x").attr("transform","translate(0,"+(this.box.height-cfg.xaxisHeight-cfg.xaxisPb)+")").transition().duration(350).call(t),(t=d3.select(this.svg.trend).selectAll("g.axis-y").data([1],function(t){return t})).exit().remove(),t.enter().append("g").attr("class","axis-y").call(g),d3.select(this.svg.trend).selectAll("g.axis-y").attr("transform","translate("+(cfg.yaxisWidth+cfg.yaxisPl)+",0)").transition().duration(350).call(g),this.renderLine(),this.renderCircle(),this.renderRect(),this.active&&this.bipolar?(g=n.filter(function(t){return f.active.catname===t.catname})[0])?(p=g.pts.map(function(t){return{data:t,year:t.year,x:f.scale.x(t.x)+10*Math.random(),y:f.scale.y(t.y)+10*Math.random(),cx:f.scale.x(t.x),cy:f.scale.y(t.y)}}),g=g.pts.map(function(t){return{data:t,year:t.year,fx:f.scale.x(t.x),fy:f.scale.y(t.y),cx:f.scale.x(t.x),cy:f.scale.y(t.y)}}),(g=d3.forceSimulation().nodes(p.concat(g)).force("charge",d3.forceManyBody().strength(-120)).force("sticky",function(n){return p.map(function(t){var e=Math.sqrt(Math.pow(t.cx-t.x,2)+Math.pow(t.cy-t.y,2));if(t.x=t.x+(t.cx-t.x)*(e-20)*.02*n,t.y=t.y+(t.cy-t.y)*(e-20)*.02*n,t.x>=u.w+u.x&&(t.x=u.w+u.x),t.y>=u.h+u.y&&(t.y=u.h+u.y),t.x<=u.x&&(t.x=u.x),t.y<=u.y)return t.y=u.y})})).stop(),g.tick(100),(g=d3.select(this.svg.trend).selectAll("text.year-label").data(p,function(t){return t.year})).exit().remove(),g.enter().append("text").attr("class","year-label").attr("font-size",".7em").attr("dy",".38em").attr("text-anchor","middle"),d3.select(this.svg.trend).selectAll("text.year-label").text(function(t){return t.year}).attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).transition().duration(150).attr("opacity",.7),(g=d3.select(this.svg.trend).selectAll("line.year-label").data(p,function(t){return t.year})).exit().remove(),g.enter().append("line").attr("class","year-label").attr("stroke","#ccc").attr("stroke-width",1).attr("stroke-dasharray","2 2"),d3.select(this.svg.trend).selectAll("line.year-label").text(function(t){return t.year}).attr("x1",function(t){return t.cx}).attr("y1",function(t){return t.cy}).attr("x2",function(t){return t.x}).attr("y2",function(t){return t.y}).transition().duration(150).attr("opacity",.7)):void 0:d3.select(this.svg.trend).selectAll(".year-label").transition().duration(150).attr("opacity",0)}});