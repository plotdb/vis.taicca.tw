(function(){var rescope,sanitize,parseNameString,pubsub,block,slice$=[].slice;rescope=typeof window!="undefined"&&window!==null?window.rescope:typeof module!="undefined"&&module!==null&&(typeof require!="undefined"&&require!==null)?require("@plotdb/rescope"):null;sanitize=function(code){return code||""};parseNameString=function(n){var ref$,v;n=n.split("@");ref$=!n[0]?["@"+n[1],n[2]]:[n[0],n[1]],n=ref$[0],v=ref$[1];return{name:n,version:v}};pubsub=function(){this.subs={};return this};pubsub.prototype=import$(Object.create(Object.prototype),{fire:function(name){var args,res$,i$,to$,ref$;res$=[];for(i$=1,to$=arguments.length;i$<to$;++i$){res$.push(arguments[i$])}args=res$;return Promise.all(((ref$=this.subs)[name]||(ref$[name]=[])).map(function(it){return it.apply(null,args)}))},on:function(name,cb){var ref$;return((ref$=this.subs)[name]||(ref$[name]=[])).push(cb)}});block={};block.i18n={module:{lng:"en",t:function(v){var vs,lng,i$,to$,i,ref$,ns,t,that,ref1$;vs=Array.isArray(v)?v:[v];lng=this.lng;for(i$=0,to$=vs.length;i$<to$;++i$){i=i$;ref$=vs[i].split(":"),ns=ref$[0],t=slice$.call(ref$,1);t=t.join(":");if(that=((ref$=(ref1$=this.res)[lng]||(ref1$[lng]={}))[ns]||(ref$[ns]={}))[t]){return that}}return t||ns||v[v.length-1]},changeLanguage:function(it){return this.lng=it||"en"},addResourceBundle:function(lng,ns,res,deep,overwrite){var ref$;return((ref$=this.res)[lng]||(ref$[lng]={}))[ns]=res},res:{}},use:function(it){return this.module=it}};block.global={csscope:{hash:{},apply:function(ret){var this$=this;ret=ret.filter(function(it){return!this$.hash[it.url]}).map(function(it){return this$.hash[it.url]=it.scope});if(ret.length){return document.body.classList.add.apply(document.body.classList,ret)}}}};block.init=proxise.once(function(){return block.rescope.init()});block.rescope=new rescope({global:window});block.csscope=new csscope.manager;block.manager=function(opt){var this$=this;opt==null&&(opt={});this.hash={};this.proxy={};this.running={};this.setRegistry(opt.registry);this.init=proxise.once(function(){return this$._init()});this.init();return this};block.manager.prototype=import$(Object.create(Object.prototype),{_init:function(){return block.init()},setRegistry:function(it){var ref$;this.reg=it||"";if(typeof this.reg==="string"){if(this.reg&&(ref$=this.reg)[ref$.length-1]!=="/"){return this.reg+="/"}}},set:function(opt){var opts,this$=this;opt==null&&(opt={});opts=Array.isArray(opt)?opt:[opt];return Promise.all(opts.map(function(obj){var name,version,b,ref$;name=obj.name,version=obj.version;b=obj instanceof block["class"]?obj:obj.block;((ref$=this$.hash)[name]||(ref$[name]={}))[version]=b;return b.init()}))},getUrl:function(arg$){var name,version;name=arg$.name,version=arg$.version;if(typeof this.reg==="function"){return this.reg({name:name,version:version})}else{return(this.reg||"")+"/block/"+name+"/"+version}},_get:function(opt){var ref$,n,v,this$=this;ref$=[opt.name,opt.version||"latest"],n=ref$[0],v=ref$[1];if(!(n&&v)){return Promise.reject((ref$=new Error,ref$.name="lderror",ref$.id=1015,ref$))}if(((ref$=this.hash)[n]||(ref$[n]={}))[v]!=null&&!opt.force){return this.hash[n][v]?Promise.resolve(this.hash[n][v]):Promise.reject((ref$=new Error,ref$.name="lderror",ref$.id=404,ref$))}if(((ref$=this.running)[n]||(ref$[n]={}))[v]===true){return}this.running[n][v]=true;return ld$.fetch(this.getUrl({name:opt.name,version:opt.version}),{method:"GET"},{type:"text"}).then(function(ret){var b,obj;ret==null&&(ret={});b=new block["class"]({code:ret,name:n,version:v,manager:this$});this$.set(obj={name:n,version:v,block:b});if(ret.version&&ret.version!==v){this$.set((obj.version=ret.version,obj))}return b.init().then(function(){return b})}).then(function(it){this$.proxy[n][v].resolve(it);return it})["finally"](function(){return this$.running[n][v]=false})["catch"](function(e){this$.proxy[n][v].reject(e);return Promise.reject(e)})},get:function(opt){var opts,this$=this;opt==null&&(opt={});opts=Array.isArray(opt)?opt:[opt];return Promise.all(opts.map(function(opt){var ref$,n,v;opt==null&&(opt={});if(typeof opt==="string"){opt=parseNameString(opt)}ref$=[opt.name,opt.version||"latest"],n=ref$[0],v=ref$[1];if(!((ref$=this$.proxy)[n]||(ref$[n]={}))[v]){this$.proxy[n][v]=proxise(function(opt){return this$._get(opt)})}return this$.proxy[n][v](opt)})).then(function(it){if(Array.isArray(opt)){return it}else{return it[0]}})}});block["class"]=function(opt){var code,div,node,this$=this;opt==null&&(opt={});this.opt=opt;this.scope="_"+Math.random().toString(36).substring(2);this._ctx={};this.csscope={global:[],local:[]};this.name=opt.name;this.version=opt.version;this.extend=opt.extend;this.manager=opt.manager;code=opt.code;if(opt.root){code=(typeof opt.root==="string"?document.querySelector(opt.root):opt.root).innerHTML}if(typeof code==="function"){code=code()}if(typeof code==="string"){this.code=sanitize(code);div=document.createElement("div");div.innerHTML=this.code;if(div.childNodes.length>1){console.warn("DOM definition of a block should contain only one root.")}node=div.childNodes[0]}else if(typeof code==="object"){this.script=code.script;this.style=code.style;code=code.dom instanceof Function?code.dom():code.dom;this.code=sanitize(code);div=document.createElement("div");div.innerHTML=this.code;if(div.childNodes.length>1){console.warn("DOM definition of a block should contain only one root.")}node=div.childNodes[0]}if(!node){node=document.createElement("div")}["script","style","link"].map(function(n){var v;v=Array.from(node.querySelectorAll(n)).map(function(it){it.parentNode.removeChild(it);return it.textContent}).join("\n");return this$[n]=v!=null&&v?v:this$[n]||""});this.node=node;this.init=proxise.once(function(){return this$._init()});this.init();return this};block["class"].prototype=import$(Object.create(Object.prototype),{_init:function(){var this$=this;return block.init().then(function(){var v,ref$,ret;this$["interface"]=this$.script instanceof Function?this$.script():typeof this$.script==="object"?this$.script:(v=eval(this$.script||""))instanceof Function?v():v||{};if(!this$["interface"]){this$["interface"]={}}(ref$=this$["interface"]).pkg||(ref$.pkg={});document.body.appendChild(this$.styleNode=document.createElement("style"));this$.styleNode.setAttribute("type","text/css");this$.styleNode.textContent=ret=csscope({scope:"*[scope="+this$.scope+"]",css:this$.style,scopeTest:"[scope]"});this$.factory=function(){var args,res$,i$,to$;res$=[];for(i$=0,to$=arguments.length;i$<to$;++i$){res$.push(arguments[i$])}args=res$;return this};return this$.factory.prototype=import$((ref$=Object.create(Object.prototype),ref$.init=function(){},ref$.destroy=function(){},ref$),this$["interface"])}).then(function(){this$["extends"]=[];if(!this$["interface"].pkg.extend){return}if(!this$.manager){return new Error("no available manager to get extended block")}return this$.manager.get(this$["interface"].pkg.extend).then(function(it){this$.extend=it;this$.extendDom=!(this$["interface"].pkg.extend.dom!=null)||this$["interface"].pkg.extend.dom;return this$["extends"]=[this$.extend].concat(this$.extend["extends"])})}).then(function(){var i18n,lng,res,ns,results$=[];i18n=this$["interface"].pkg.i18n||{};for(lng in i18n){res=i18n[lng];ns=this$["interface"].pkg.name+"@"+this$["interface"].pkg.version;results$.push(block.i18n.module.addResourceBundle(lng,ns,res,true,true))}return results$}).then(function(){var ref$,k,v;this$.dependencies=Array.isArray(((ref$=this$["interface"]).pkg||(ref$.pkg={})).dependencies)?((ref$=this$["interface"]).pkg||(ref$.pkg={})).dependencies:function(){var ref$,ref1$,results$=[];for(k in ref$=((ref1$=this["interface"]).pkg||(ref1$.pkg={})).dependencies||{}){v=ref$[k];results$.push(v)}return results$}.call(this$);if(this$.extend){this$._ctx=this$.extend.context()}return block.rescope.load(this$.dependencies.filter(function(it){return/\.js$/.exec(it.url||it)||it.type==="js"}),this$._ctx)}).then(function(){return block.csscope.load(this$.dependencies.filter(function(it){return(/\.css$/.exec(it.url||it)||it.type==="css")&&it.global===true}).map(function(it){return it.url||it}))}).then(function(it){(this$.csscope||(this$.csscope={})).global=it||[];return block.csscope.load(this$.dependencies.filter(function(it){return(/\.css$/.exec(it.url||it)||it.type==="css")&&it.global!==true}).map(function(it){return it.url||it}))}).then(function(it){return this$.csscope.local=(it||[]).concat(this$.extend?this$.extend.csscope.local||[]:[])})["catch"](function(e){var node;console.error(e);node=document.createElement("div");node.innerText="failed";return this$["interface"]={},this$.styleNode={},this$.factory=function(){return this},this$.dependencies=[],this$})},context:function(){return this._ctx},dom:function(){return this.node},i18n:function(t){var p;p=this["interface"].pkg;return block.i18n.module.t([p.name+"@"+p.version+":"+t].concat(this["extends"].map(function(it){return it.name+"@"+it.version+":"+t}),[t]))},create:function(opt){var ret;opt==null&&(opt={});ret=new block.instance({block:this,name:this.name,version:this.version,data:opt.data});return ret.init().then(function(){return ret})},resolvePlugAndCloneNode:function(child){var node;node=this.dom().cloneNode(true);if(child){Array.from(node.querySelectorAll("plug")).map(function(it){var name,n;name=it.getAttribute("name");n=child.querySelector(":scope :not([plug]) [plug="+name+"], :scope > [plug="+name+"]");if(n){return it.replaceWith(n)}})}return this.extend&&this.extendDom?this.extend.resolvePlugAndCloneNode(node):node}});block.instance=function(opt){var this$=this;opt==null&&(opt={});this.name=opt.name;this.version=opt.version;this.block=opt.block;this.data=opt.data;this.init=proxise.once(function(){return this$._init()});return this};block.instance.prototype=import$(Object.create(Object.prototype),{_init:function(){return this.block.init()},attach:function(opt){var root,node;opt==null&&(opt={});if(opt.data){this.data=opt.data}root=opt.root;root=!root?null:typeof root==="string"?document.querySelector(root):root;block.global.csscope.apply(this.block.csscope.global);if(!root){node=null}else{node=this.dom();node.setAttribute("scope",this.block.scope);node.classList.add.apply(node.classList,this.block.csscope.local.map(function(it){return it.scope}).concat(this.block.csscope.global.map(function(it){return it.scope})));root.appendChild(node)}return this.run({node:node,type:"init"})},detach:function(){var node;node=this.dom();node.parentNode.removeChild(node);return this.run({node:node,type:"destroy"})},interface:function(){var i$,i,ret;for(i$=this.obj.length;i$>=0;--i$){i=i$;if(!(ret=(this.obj[i]||{})["interface"])){continue}return ret instanceof Function?ret.apply(this.obj[i]):ret}return null},update:function(ops){return this.datadom.update(ops)},dom:function(){var that;if(that=this.node){return that}else{return this.node=this.block.resolvePlugAndCloneNode()}},i18n:function(it){return this.block.i18n(it)},run:function(arg$){var node,type,cs,ps,c,this$=this;node=arg$.node,type=arg$.type;cs=[];ps=[];c=this.block;if(!this.obj){this.obj=[]}if(!this.pubsub){this.pubsub=new pubsub}while(c){cs=[c].concat(cs);c=c.extend}return new Promise(function(res,rej){var _;_=function(list,idx,gtx,parent){var p,b,ref$;list==null&&(list=[]);idx==null&&(idx=0);gtx==null&&(gtx={});if(list.length<=idx){p=Promise.all(ps).then(function(it){return res(it)})["catch"](function(it){return rej(it)});return p}b=list[idx];return block.rescope.context((ref$=b._ctx).local||(ref$.local={}),function(ctx){var payload,o;import$(gtx,ctx);payload={root:node,parent:parent,ctx:gtx,context:gtx,pubsub:this$.pubsub,i18n:{t:function(it){return this$.block.i18n(it)}},t:function(it){return this$.block.i18n(it)},data:this$.data};if(type==="init"){this$.obj.push(o=new b.factory(payload))}ps.push((o=this$.obj[idx])?this$.obj[idx][type](payload):null);return _(list,idx+1,gtx,o)})};return _(cs,0,{})})}});if(typeof module!="undefined"&&module!==null){module.exports=block}if(typeof window!="undefined"&&window!==null){window.block=block}function import$(obj,src){var own={}.hasOwnProperty;for(var key in src)if(own.call(src,key))obj[key]=src[key];return obj}}).call(this);
