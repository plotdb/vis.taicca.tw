<div><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="view"></div><div class="pdl-cell" data-name="unit"></div><div class="pdl-cell" data-name="legend"></div></div><div data-type="render"></div></div></div><style type="text/css">/*.pdl-cell { width: 100%; height: 100% }*/
.pdl-layout > div[data-type=layout] {
  display: grid;
  grid-template-columns: 1fr fit-content(10em);
  grid-template-rows: 1fr fit-content(1em);
}
.pdl-layout > div[data-type=layout] > .pdl-cell[data-name=view] {
  grid-area: 1/1;
}
.pdl-layout > div[data-type=layout] > .pdl-cell[data-name=legend] {
  grid-column: 2;
  grid-row: 1/span 2;
  padding: 0 0.5em 0 0.5em;
}
.pdl-layout > div[data-type=layout] > .pdl-cell[data-name=unit] {
  grid-column: 1;
  grid-row: 2;
  line-height: 1em;
  text-align: right;
  padding: 0.25em 0;
}
.pdl-layout.legend-bottom > div[data-type=layout] {
  grid-template-columns: 1fr fit-content(1em);
  grid-template-rows: 1fr fit-content(3em);
}
.pdl-layout.legend-bottom > div[data-type=layout] .pdl-cell[data-name=view] {
  grid-column: 1/span 2;
  grid-row: 1;
}
.pdl-layout.legend-bottom > div[data-type=layout] .pdl-cell[data-name=legend] {
  padding-top: 1em;
  grid-column: 1;
  grid-row: 2;
}
.pdl-layout.legend-bottom > div[data-type=layout] .pdl-cell[data-name=unit] {
  padding-top: 1em;
  grid-column: 2;
  grid-row: 2;
}
</style><script type="@plotdb/block">var mod;
module.exports = {
  pkg: {
    name: 'bubble',
    version: '0.0.1',
    extend: {
      name: "base",
      version: "0.0.1"
    },
    dependencies: [],
    i18n: {
      "zh-TW": {
        "K": '千',
        "M": '百萬'
      }
    }
  },
  init: function(arg$){
    var root, context, pubsub, t;
    root = arg$.root, context = arg$.context, pubsub = arg$.pubsub, t = arg$.t;
    return pubsub.fire('init', {
      mod: mod({
        context: context,
        t: t
      })
    }).then(function(it){
      return it[0];
    });
  }
};
mod = function(arg$){
  var context, t, d3, forceBoundary, ldcolor, chart;
  context = arg$.context, t = arg$.t;
  d3 = context.d3, forceBoundary = context.forceBoundary, ldcolor = context.ldcolor, chart = context.chart;
  return {
    sample: function(){
      return {
        raw: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100].map(function(val){
          return {
            val: val,
            cat: Math.floor(Math.random() * 5),
            name: val
          };
        }),
        binding: {
          group: {
            key: 'cat'
          },
          name: {
            key: 'name'
          },
          color: {
            key: 'cat'
          },
          area: {
            key: 'val'
          }
        }
      };
    },
    config: import$({}, chart.utils.config.preset['default']),
    dimension: {
      group: {
        type: 'C',
        name: "group",
        priority: 2
      },
      color: {
        type: 'NR',
        name: "color",
        priority: 4
      },
      area: {
        type: 'R',
        name: "area",
        priority: 1
      },
      name: {
        type: 'NC',
        name: "name",
        priority: 3
      }
    },
    init: function(){
      var tint, node, ref$, this$ = this;
      this.tint = tint = new chart.utils.tint();
      this.parsed = this.parsed || [];
      this.g = Object.fromEntries(['view', 'unit', 'legend'].map(function(it){
        return [it, d3.select(this$.layout.getGroup(it))];
      }));
      node = this.root.querySelector('[ld=tip]');
      this.tip = new chart.utils.tip({
        root: this.root,
        accessor: function(arg$){
          var evt, data;
          evt = arg$.evt;
          if (!(evt.target && (data = d3.select(evt.target).datum()))) {
            return null;
          }
          return {
            name: data.name,
            value: data.area + "" + (this$.binding.area.unit || '')
          };
        },
        range: function(){
          return this$.layout.getNode('view').getBoundingClientRect();
        }
      });
      this.legend = new chart.utils.legend({
        layout: this.layout,
        name: 'legend',
        root: this.root,
        shape: function(d){
          return d3.select(this).attr('fill', tint.get(d.key));
        },
        direction: ((ref$ = this.cfg).legend || (ref$.legend = {})).position === 'bottom' ? 'horizontal' : 'vertical',
        cfg: {
          selectable: true
        }
      });
      return this.legend.on('select', function(){
        this$.bind();
        this$.resize();
        return this$.render();
      });
    },
    destroy: function(){
      return this.tip.destroy();
    },
    parse: function(){
      this.valid = this.data.filter(function(it){
        return !isNaN(it.area);
      });
      this.groups = Array.from(new Set(this.valid.map(function(it){
        return it.group;
      }))).filter(function(it){
        return it;
      });
      this.sim = null;
      return this.legend.data(this.groups.map(function(it){
        return {
          key: it,
          text: it
        };
      }));
    },
    resize: function(){
      var ref$, list, ret, box, pack, this$ = this;
      this.root.querySelector('.pdl-layout').classList.toggle('legend-bottom', ((ref$ = this.cfg).legend || (ref$.legend = {})).position === 'bottom');
      this.tip.toggle(((ref$ = this.cfg).tip || (ref$.tip = {})).enabled != null ? this.cfg.tip.enabled : true);
      (ref$ = this.cfg).legend || (ref$.legend = {});
      this.random = d3.randomUniform.source(d3.randomLcg(+Date.now()))(0, 1);
      list = [{
        key: 'root',
        root: true
      }].concat(this.groups.map(function(it){
        return {
          key: "group-" + it
        };
      }), this.valid.filter(function(it){
        return !this$.cfg.legend.enabled || this$.legend.isSelected(it.group);
      }));
      if (this.legend.enabled()) {
        list = list.filter(function(it){
          return !it._raw || this$.legend.isSelected(it.group);
        });
      }
      this.legend.config(this.cfg.legend);
      this.legend.update();
      this.layout.update(false);
      ret = d3.hierarchy(d3.stratify().id(function(it){
        if (it._idx != null) {
          return it._idx;
        } else {
          return it.key;
        }
      }).parentId(function(it){
        var that;
        if (it.root) {
          return '';
        } else if (that = it.group) {
          return "group-" + that;
        } else {
          return 'root';
        }
      })(list)).sum(function(it){
        return it.data.area;
      }).sort(function(a, b){
        return b.value - a.value;
      });
      box = this.vbox = this.layout.getBox('view');
      pack = d3.pack().size([box.width, box.height])(ret);
      this.parsed = ret.leaves().map(function(d){
        var ddata, pos, od, p, x, y;
        d._raw = d.data.data._raw;
        ddata = d.data.data;
        pos = !(this$.cfg.grouping != null) && this$.cfg.grouping
          ? d
          : {
            x: Math.random() * box.width * 0.8 + box.width * 0.1,
            y: Math.random() * box.height * 0.8 + box.height * 0.1
          };
        od = this$.parsed ? (p = this$.parsed.filter(function(p){
          if (p.name != null || ddata.name != null) {
            return p.name === ddata.name;
          } else {
            return p._idx === ddata._idx;
          }
        })[0], p ? p : d) : d;
        x = d.x, y = d.y;
        d.radius = Math.pow(ddata.area, 0.5);
        d.x = x;
        d.y = y;
        d._idx = ddata._idx;
        d.name = ddata.name;
        d.color = ddata.color;
        d.group = ddata.group;
        d.area = ddata.area;
        if (od._x) {
          d._x = od._x;
        } else if (!d._x) {
          d._x = d.x;
        }
        if (od._y) {
          d._y = od._y;
        } else if (!d._y) {
          d._y = d.y;
        }
        return d;
      }).filter(function(it){
        return it.area != null;
      });
      this.sim = null;
      return this.start();
    },
    render: function(){
      var binding, tint, box, rate, x$, y$, this$ = this;
      binding = this.binding, tint = this.tint;
      box = this.vbox;
      this.rate = rate = 0.85 * Math.PI / (2 * Math.sqrt(3)) * Math.sqrt(box.width * box.height / this.parsed.map(function(it){
        return Math.PI * Math.pow(it.r, 2);
      }).reduce(function(a, b){
        return a + b;
      }, 0));
      this.parsed.map(function(d, i){
        var ref$;
        return d.rr = (ref$ = d.r * this$.rate) > 2 ? ref$ : 2;
      });
      tint.set(this.cfg.palette);
      x$ = this.g.view.selectAll('circle.bubble').data(this.parsed, function(it){
        return it.name || it._idx;
      });
      x$.exit().remove();
      x$.enter().append('circle').attr('class', 'bubble data').attr('r', function(d, i){
        return 0;
      }).attr('fill', function(d, i){
        return tint.get(d.color || d.group || d.name);
      }).attr('cx', function(d, i){
        return d._x;
      }).attr('cy', function(d, i){
        return d._y;
      });
      this.g.view.selectAll('circle.bubble').attr('cx', function(d, i){
        return d._x;
      }).attr('cy', function(d, i){
        return d._y;
      }).transition().duration(350).attr('fill', function(d, i){
        return tint.get(d.color || d.group || d.name);
      }).attr('r', function(d, i){
        return d.rr;
      });
      y$ = this.g.view.selectAll('g.label').data(this.parsed, function(it){
        return it.name || it._idx;
      });
      y$.exit().remove();
      y$.enter().append('g').attr('class', 'label data').attr('transform', function(d, i){
        return "translate(" + d.x + "," + d.y + ")";
      }).attr('opacity', 0).style('pointer-events', 'none').style('cursor', 'pointer').each(function(d, i){
        var this$ = this;
        return [0, 1].map(function(){
          return d3.select(this$).append('text');
        }).map(function(it){
          return it.attr('dy', '-.28em').attr('text-anchor', 'middle').style('pointer-event', 'none');
        });
      });
      this.g.view.selectAll('g.label').attr('transform', function(d, i){
        return "translate(" + d._x + "," + d._y + ")";
      }).each(function(d, i){
        return d3.select(this).selectAll('text').attr('dy', function(e, i){
          if (i === 0) {
            return '-.28em';
          } else {
            return '.88em';
          }
        }).text(function(e, i){
          var area, ret;
          if (i === 0) {
            area = d3.format('.3s')(d.area);
            /*
            ret = if area > 1000000 => (area/1000000).toFixed(1) + t(\M)
            else if area > 1000 => (area/1000).toFixed(1) + t(\K)
            else (area).toFixed(0)
            */
            ret = area;
            if (ret) {
              ret = ret + "" + (binding.area.unit || '');
            }
            return ret;
          } else {
            return d.name || '';
          }
        }).attr('font-size', function(d, i){
          return i ? '0.9em' : '1.1em';
        }).transition().duration(350).attr('fill', function(){
          var hcl;
          hcl = ldcolor.hcl(tint.get(d.color) || d.group || d.name);
          if (hcl.l < 50) {
            return '#fff';
          } else {
            return '#000';
          }
        });
      });
      this.g.view.selectAll('g.label').transition().duration(350).attr('opacity', function(d, i){
        var box, ref$, w, h;
        box = this.getBoundingClientRect();
        ref$ = [box.width, box.height], w = ref$[0], h = ref$[1];
        if (2 * d.rr < w || 2 * d.rr < h) {
          return 0;
        } else {
          return 1;
        }
      });
      return this.legend.render();
    },
    tick: function(){
      var pad, box, kickoff, fc, this$ = this;
      pad = this.cfg.pad || 5;
      box = this.vbox;
      if (!this.sim) {
        kickoff = true;
        this.fc = fc = d3.forceCollide().strength(0.5).iterations(20).radius(function(it){
          return this$.rate * it.r;
        });
        this.fg = d3.forceCenter().strength(0.5);
        this.fb = forceBoundary(function(it){
          return it.rr + pad;
        }, function(it){
          return it.rr + pad;
        }, function(it){
          return box.width - it.rr - pad;
        }, function(it){
          return box.height - it.rr - pad;
        }).strength(0.5);
        this.sim = d3.forceSimulation().force('b', this.fb).force('collide', this.fc);
        this.sim.stop();
        this.sim.alpha(0.9);
      }
      this.fg.x(box.width / 2);
      this.fg.y(box.height / 2);
      this.sim.nodes(this.parsed);
      this.sim.tick(kickoff ? 10 : 1);
      this.parsed.map(function(it){
        it._x = it._x + (it.x - it._x) * 0.1;
        return it._y = it._y + (it.y - it._y) * 0.1;
      });
      this.g.view.selectAll('circle.bubble').attr('cx', function(d, i){
        return d._x;
      }).attr('cy', function(d, i){
        return d._y;
      });
      return this.g.view.selectAll('g.label').attr('transform', function(d, i){
        return "translate(" + d._x + "," + d._y + ")";
      });
    }
  };
};
function import$(obj, src){
  var own = {}.hasOwnProperty;
  for (var key in src) if (own.call(src, key)) obj[key] = src[key];
  return obj;
}</script></div>