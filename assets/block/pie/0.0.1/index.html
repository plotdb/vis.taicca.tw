<div><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="view"></div><div class="pdl-cell" data-name="legend"></div></div><div data-type="render"></div></div></div><style type="text/css">.pdl-layout>div[data-type=layout]{display:flex;justify-content:center;align-items:center}.pdl-layout>div[data-type=layout]>[data-name=view]{height:100%;margin-right:1em}.pdl-layout>div[data-type=layout]>[data-name=legend]{min-width:6em}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"pie",version:"0.0.1",extend:{name:"base",version:"0.0.1"},dependencies:[],i18n:{"zh-TW":{value:"數值",name:"名稱",category:"分類",other:"其它"}}},init:function(t){var e,n,r,i;e=t.root,n=t.context,r=t.pubsub,i=t.t;return r.fire("init",{mod:mod({context:n,t:i})})}};mod=function(t){var e,n,r,a;e=t.context,n=t.t;r=e.chart,a=e.d3;return{sample:function(){return{raw:[1,2,3,4,5,6,7].map(function(t){return{val:(10*Math.random()).toFixed(2),name:t}}),binding:{name:{key:"name"},category:[{key:"c1"},{key:"c2"},{key:"c3"}],value:{key:"val"}}}},config:{},dimension:{name:{type:"CNO",name:"name",priority:10},value:{type:"R",name:"value",priority:20},category:{type:"C",name:"category",priority:25,multiple:true}},init:function(){var e,i=this;this.g=Object.fromEntries(["view","legend"].map(function(t){return[t,a.select(i.layout.getGroup(t)).append("g")]}));this.tint=e=new r.utils.tint;this.tip=new r.utils.tip({root:this.root,accessor:function(t){var e,n,r;e=t.evt;if(!(e.target&&(n=a.select(e.target).datum()))){return null}r=isNaN(n.value)?"-":n.value.toFixed(2)+""+(i.binding.value.unit||"");return{name:n.name,value:r}},range:function(){return i.layout.getNode("view").getBoundingClientRect()}});this.legend=new r.utils.legend({layout:this.layout,name:"legend",root:this.root,shape:function(t){return a.select(this).attr("fill",e.get(t.text))},cfg:{selectable:true}});this.legend.on("select",function(){i.bind();i.resize();return i.render()});this.arc=a.arc().innerRadius(0).outerRadius(100).startAngle(0).endAngle(Math.PI/2);return this.total={}},destroy:function(){return this.tip.destroy()},parse:function(){var f,g;this.tint.reset();f=this.binding.category||[];g=function(e,n,t,r){var i,a,o,u,l,s,c;n==null&&(n=0);t==null&&(t={});r==null&&(r=[]);i=n>=f.length-1;if(i){a=e}else{o=Array.from(new Set(e.map(function(t){return t.category[n]})));a=o.map(function(t){return{_cat:t,colorKey:n?e[0].category[n-1]:t}})}for(u=0,l=a.length;u<l;++u){s=a[u];s.parent=t;r.push(s);c=e.filter(d);s.value=c.reduce(h,0);s._lv=n;if(!i){g(c,n+1,s,r)}}a.sort(function(t,e){return e.value-t.value});return r;function d(t){return t.category[n]===s._cat}function h(t,e){return t+e.value}};this.parsed=this.data.map(function(t){var e;e=import$({},t);if(isNaN(e.value)){e.value=0}e.colorKey=(e.category||(e.category=[]))[0]!=null?(e.category||(e.category=[]))[0]:e.name;return e});this.parsed.sort(function(t,e){return e.value-t.value});return this.legend.data(this.parsed.map(function(t){return{text:t.name,key:t.name}}))},bind:function(){var t,e,n,r,i,a,o=this,u=[];this.parsed.map(function(t){return t.picked=o.legend.isSelected(t.name)});this.total.old=this.total.cur;this.total.cur=this.parsed.reduce(function(t,e){return t+(e.picked?e.value:0)},0)||1;if(!this.total.old){this.total.old=this.total.cur}t=0;for(e=0,n=this.parsed.length;e<n;++e){r=e;i=this.parsed[r];if(!i.old){i.old={s:(a=this.parsed[r-1])?a.old.e:0,e:0}}if(i.cur){i.old=i.cur}i.cur={s:t,e:t+(i.picked?i.value:0)};i.angle={old:{s:2*Math.PI*i.old.s/this.total.old,e:2*Math.PI*i.old.e/this.total.old},cur:{s:2*Math.PI*i.cur.s/this.total.cur,e:2*Math.PI*i.cur.e/this.total.cur}};if(i.picked){u.push(t+=i.value)}}return u},resize:function(){var t,e,n,r,i;this.layout.update(false);t=this.layout.getBox("view");this.layout.getNode("view").style.width=t.height+"px";this.layout.update(false);t=this.layout.getBox("view");e=[t.width,t.height],n=e[0],r=e[1];i=Math.min(n,r);return this.arc.innerRadius((this.cfg.donutPercent||.7)*i/2).outerRadius(i/2)},render:function(){var t,n,e,r,o=this;t=this.tint;n=function(i,a){return function(e){var t,n,r;t=["s","e"].map(function(t){return(a[t]-i[t])*e+i[t]}),n=t[0],r=t[1];o.arc.startAngle(n).endAngle(r);return o.arc()}};if(this.cfg!=null&&this.cfg.palette){this.tint.set(this.cfg.palette.colors.map(function(t){return t.value||t}))}e=this.layout.getBox("view");this.g.view.attr("transform","translate("+e.width/2+","+e.height/2+")");r=this.g.view.selectAll("path.data").data(this.parsed,function(t){return t.name||t._idx});r.exit().remove();r.enter().append("path").attr("class","data");this.g.view.selectAll("path.data").attr("fill",function(t,e){return o.tint.get(t.colorKey||t._idx)}).transition().duration(350).attrTween("d",function(t,e){return n(t.angle.old,t.angle.cur)});return this.legend.render()}}};function import$(t,e){var n={}.hasOwnProperty;for(var r in e)if(n.call(e,r))t[r]=e[r];return t}</script></div>