<div><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="yaxis">&nbsp;</div><div class="pdl-cell" data-name="view"></div><div class="pdl-cell"></div><div class="pdl-cell" data-name="xaxis">&nbsp;</div><div class="pdl-cell" data-name="legend">&nbsp;</div></div><div data-type="render"></div></div></div><style type="text/css">[data-name=xaxis]{font-size:.8em}[data-name=yaxis]{font-size:.8em}.pdl-layout>div[data-type=layout]{display:grid;grid-template-columns:fit-content(2em) 1fr fit-content(10em);grid-template-rows:1fr fit-content(1em);padding:0 .5em}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=legend]{grid-column:3;grid-row:1/span 2;padding-left:1em}.pdl-layout.legend-bottom>div[data-type=layout]{grid-template-columns:2em 1fr;grid-template-rows:1fr fit-content(2em) fit-content(3em)}.pdl-layout.legend-bottom>div[data-type=layout] .pdl-cell[data-name=legend]{padding-top:1em;grid-column:1/span 2;grid-row:3}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"bar",version:"0.0.1",extend:{name:"base",version:"0.0.1"},dependencies:[],i18n:{"zh-TW":{size:"長度"}}},init:function(t){var e,i,n,s;e=t.root,i=t.context,n=t.t,s=t.pubsub;return s.fire("init",{mod:mod({context:i,t:n})})}};mod=function(t){var e,i,n,N,s,r;e=t.context,i=t.t;n=e.chart,N=e.d3,s=e.debounce;return{sample:function(){return{raw:[0,1,2,3,4,5,6,7,8,9,10].map(function(t){var e,i,n;e={name:t};for(i=1;i<=4;++i){n=i;e["val"+n]=(10*Math.random()).toFixed(1)}return e}),binding:{size:[1,2,3,4].map(function(t){return{key:"val"+t,unit:"amount"}}),name:{key:"name"}}}},config:(r=import$({legend:import$({},n.utils.config.preset.legend),xaxis:JSON.parse(JSON.stringify(n.utils.config.preset.axis)),yaxis:JSON.parse(JSON.stringify(n.utils.config.preset.axis))},n.utils.config.preset["default"]),r.sort={enabled:{type:"boolean",default:false},dir:{type:"choice",values:["asc","desc"],default:"asc"},dimension:{type:"choice",values:["name","size"],default:"size"}},r.type={type:"choice",values:["bar","column"],default:"column"},r.brush={enabled:{type:"boolean",default:true}},r.multiple={type:"choice",values:["stack","group"],default:"stack"},r.percent={type:"boolean",default:false},r.dancing={type:"boolean",default:true},r.gap={type:"number",default:2,min:0,max:100,step:1},r),dimension:{size:{type:"R",multiple:true,name:"size"},name:{type:"NCO",name:"name"}},init:function(){var e,i,t,u=this;this.tint=e=new n.utils.tint;this.svg.addEventListener("click",function(t){var e,i;e=t.target;while(e!==u.svg){if(!e){return}if(!(e.classList&&e.classList.contains("pdl-cell"))){e=e.parentNode;continue}if(e.getAttribute("data-name")==="view"){break}else{return}}if(!u.cfg.dancing||u.cfg.percent){return}i=u.alignIdx||0;for(;;){u.alignIdx=((u.alignIdx||0)+1)%(u.binding.size.length+1);if(u.legend.isSelected(u.alignIdx)||u.alignIdx===i){break}}u.resize();return u.render()});this.g=Object.fromEntries(["view","xaxis","yaxis","legend"].map(function(t){return[t,N.select(u.layout.getGroup(t))]}));this.g.subview=this.g.view.append("g");this.g.brush=this.g.view.append("g");this.brushs={x:N.brushX(),y:N.brushY()};this.brushType=function(){if(u.cfg.type==="bar"){return"y"}else{return"x"}};this.range="null";i=s(150,function(t){var n,e,s,r,i,a;if(!u.cfg.brush.enabled){return}n=t.selection;if((e=JSON.stringify(n))===u.range){return}else{u.range=e}if(!n){return u.filter({name:undefined},true)}else{s=u.scale[u.brushType()].domain();r=u.scale[u.brushType()].bandwidth();if(u.brushType()==="x"){n=n.map(function(t){var e,i,n;return(e=(n=Math.floor(t/r))>0?n:0)<(i=s.length-1)?e:i});i=function(){var t,e,i=[];for(t=n[0],e=n[1];t<=e;++t){i.push(t)}return i}().map(function(t){return s[t]})}else{a=u.layout.getBox("view");n=n.map(function(t){var e,i,n;return(e=(n=Math.floor((a.height-t)/r))>0?n:0)<(i=s.length-1)?e:i});i=function(){var t,e,i=[];for(t=n[1],e=n[0];t<=e;++t){i.push(t)}return i}().map(function(t){return s[t]})}return u.filter({name:{type:"index",value:i}},true)}});this.brushs.x.on("end",function(t){if(u.brushType()==="x"){return i(t)}});this.brushs.x.on("brush",function(t){if(u.brushType()==="x"){return i(t)}});this.brushs.y.on("end",function(t){if(u.brushType()==="y"){return i(t)}});this.brushs.y.on("brush",function(t){if(u.brushType()==="y"){return i(t)}});this.scale=t={};this.yaxis=new n.utils.axis({layout:this.layout,name:"yaxis",direction:"left"});this.xaxis=new n.utils.axis({layout:this.layout,name:"xaxis",direction:"bottom"});this.legend=new n.utils.legend({layout:this.layout,name:"legend",root:this.root,shape:function(t){return N.select(this).attr("fill",e.get(t.key))}});this.legend.on("select",function(){u.bind();u.resize();return u.render()});return this.tip=new n.utils.tip({root:this.root,accessor:function(t){var e,i,n,s;e=t.evt;if(!(e.target&&(i=N.select(e.target).datum()))){return null}if((n=i.type)==="overlay"||n==="selection"||n==="s"){return}s=isNaN(i.size)?"-":i.size.toFixed(2)+""+(i.unit||"");return{name:(i.group||"")+" / "+(i.name||""),value:s}},range:function(){return u.layout.getNode("view").getBoundingClientRect()}})},destroy:function(){if(this.tip){return this.tip.destroy()}},filter:function(t,e){var i=this;e==null&&(e=false);this.render();if(e){return}return this.brush.move(this.g.view,t.name?t.name.map(function(t){return i.scale[i.brushType()](t)}):null)},parse:function(){this.data.map(function(t){return t.size=t.size.map(function(t){if(isNaN(t)){return 0}else{return t}})});return this.alignIdx=undefined},resize:function(){var i,s,t,e,n,r,a,u,h,l,o,c,f,d,g,m,p=this;this.root.querySelector(".pdl-layout").classList.toggle("legend-bottom",this.cfg.legend.position==="bottom");this.type=this.cfg.type||"column";this.brush=this.brushs[this.brushType()];this.legend.config(this.cfg.legend);this.legend.data(function(){var t,e=[];for(t=this.binding.size.length-1;t>=0;--t){i=t;e.push({key:i,text:this.binding.size[i].name||this.binding.size[i].key})}return e}.call(this));this.layout.update(false);this.maxPerGroup=this.binding.size.filter(function(t,e){return p.legend.isSelected(e)}).map(function(t,e){return Math.max.apply(Math,p.data.map(function(t){return t.size[e]}))});if(this.cfg.alignIdx&&!this.alignIdx){this.alignIdx=this.cfg.alignIdx}s=(t=this.cfg.percent?0:this.alignIdx||0)<(e=this.binding.size.length)?t:e;this.baseOffset=this.data.map(function(i){return function(){var t,e,i=[];for(t=0,e=s;t<e;++t){i.push(t)}return i}().reduce(function(t,e){return t+(!p.legend.isSelected(e)?0:i.size[e])},0)||[0]});this.delta=n=Math.max.apply(Math,this.baseOffset);if(this.cfg.multiple==="stack"){if(this.cfg.percent){r=1}else{r=Math.max.apply(Math,this.data.map(function(n){return function(){var t,e,i=[];for(t=s,e=n.size.length;t<e;++t){i.push(t)}return i}().reduce(function(t,e){return t+(!p.legend.isSelected(e)?0:n.size[e])},0)}))+(n||0)}}else if(this.cfg.multiple==="group"){r=Math.max.apply(Math,this.data.map(function(t){return Math.max.apply(Math,t.size.filter(function(t,e){return p.legend.isSelected(e)}))}))}else if(this.cfg.multiple==="split"){r=this.maxPerGroup.reduce(function(t,e){return t+e},0)}this.order=this.data.map(function(t,e){return{key:t._idx,idx:e,name:t.name}});this.data.map(function(t,e){return t.sum=t.size.filter(function(t,e){return p.legend.isSelected(e)}).reduce(function(t,e){return t+e},0)});if(((t=this.cfg).sort||(t.sort={})).enabled){this.order.sort(function(t,e){var i,n,s;i=p.cfg.sort.dimension==="size"?p.data[t.idx].sum-p.data[e.idx].sum:(n=p.data[t.idx].name,s=p.data[e.idx].name,n=isNaN(+n)?n:+n,s=isNaN(+s)?s:+s,n>s?1:n<s?-1:0);return(p.cfg.sort.dir==="asc"?1:-1)*i})}if(this.cfg.palette){this.tint.set(this.cfg.palette.colors.map(function(t){return t.value||t}))}this.layout.update(false);a=this.layout.getBox("view");if(this.type==="column"){t=this.scale;t.y=N.scaleLinear().domain([0,r]).range([a.height,0]);t.x=N.scaleBand().domain(this.order.map(function(t){return t.name||t.key})).range([0,a.width]);u=(t=Math.ceil(this.layout.getBox("yaxis").height/40))>2?t:2;h=this.cfg.bump?function(){var t,e,i,n=[];for(t=1,e=(i=this.parsed.length||1)>1?i:1;t<=e;++t){n.push(t)}return n}.call(this):this.scale.y.ticks((t=((e=this.cfg).yaxis||(e.yaxis={})).tick.count||4)<u?t:u);this.yaxis.config(this.cfg.yaxis);l=this.binding.size[0]||{};if(this.binding.size.length>1){this.yaxis.caption(l.unit?l.unit+"":"")}else{this.yaxis.caption((l.name||l.key||"")+(l.unit?"("+l.unit+")":""))}this.yaxis.ticks(h);this.yaxis.scale(this.scale.y);this.xaxis.config(this.cfg.xaxis);this.xaxis.ticks(this.data.map(function(t){return t.name}));this.xaxis.scale(this.scale.x);this.xaxis.caption((o=this.binding.name)?(o.name||o.key||"")+(o.unit?"("+this.binding.name.unit+")":""):"")}else{t=this.scale;t.x=N.scaleLinear().domain([0,r]).range([a.width,0]);t.y=N.scaleBand().domain(this.order.map(function(t){return t.name||t.key})).range([0,a.height]);u=(t=Math.ceil(this.layout.getBox("xaxis").width/80))>2?t:2;c=this.cfg.bump?function(){var t,e,i,n=[];for(t=1,e=(i=this.parsed.length||1)>1?i:1;t<=e;++t){n.push(t)}return n}.call(this):this.scale.x.ticks((t=((e=this.cfg).xaxis||(e.xaxis={})).tick.count||4)<u?t:u);this.xaxis.config(this.cfg.xaxis);l=this.binding.size[0]||{};if(this.binding.size.length>1){this.xaxis.caption(l.unit?l.unit+"":"")}else{this.xaxis.caption((l.name||l.key||"")+(l.unit?"("+l.unit+")":""))}this.xaxis.ticks(c);this.xaxis.scale(this.scale.x);this.yaxis.config(this.cfg.yaxis);this.yaxis.ticks(this.data.map(function(t){return t.name}));this.yaxis.scale(this.scale.y);this.yaxis.caption((o=this.binding.name)?(o.name||o.key||"")+(o.unit?"("+this.binding.name.unit+")":""):"")}for(f=0;f<2;++f){i=f;this.layout.update(false);a=this.layout.getBox("view");t=[a.width,a.height],d=t[0],g=t[1];this.tint.set(this.cfg.palette);m=this.cfg.dotSize||3;this.scale.x.range([0,d-m]);this.scale.y.range([g,m]);this.xaxis.render();this.yaxis.render()}a=this.layout.getBox("view");if(this.brushType()==="x"){return this.brush.extent([[0,1],[a.width,a.height-2]])}else{return this.brush.extent([[1,0],[a.width-2,a.height]])}},render:function(){var g,m,t,p,x,y,b,v,z,w,k,M,e,i,n=this;g=this.binding,m=this.scale,t=this.range,p=this.delta,x=this.baseOffset,y=this.maxPerGroup,b=this.cfg,v=this.tint,z=this.data,w=this.type,k=this.legend;M=this.cfg.gap;M<=(e=(this.type==="column"?m.x.bandwidth():m.y.bandwidth())-1)||(M=e);i=this.g.subview.selectAll("g.bar").data(this.data);i.exit().remove();i.enter().append("g").attr("class","bar").attr("transform",function(t,e){if(n.type==="column"){return"translate("+m.x(t.name)+",0)"}else{return"translate(0,"+m.y(t.name)+")"}});this.g.subview.selectAll("g.bar").transition().duration(350).attr("transform",function(t,e){if(n.type==="column"){return"translate("+m.x(t.name)+",0)"}else{return"translate(0,"+m.y(t.name)+")"}});this.g.subview.selectAll("g.bar").each(function(s,i){var t,n,e,r,a,u,h,l,o,c,f,d;t=[[],0],n=t[0],e=t[1];e=p-x[i];r=1;if(b.percent===true){r=(t=s.size.filter(function(t,e){return k.isSelected(e)}).reduce(function(t,e){return t+e},0))>1?t:1}for(a=0,u=s.size.length;a<u;++a){h=a;l=s.size[h];o=h;if(!k.isSelected(o)){continue}n.push({size:l/r,offset:e/r,key:o,group:s.name,name:g.size[o].name||g.size[o].key,unit:g.size[o].unit||"",order:n.length});if(b.multiple==="split"){e+=y[h]}else if(b.multiple==="stack"){e+=l}}c=N.select(this).selectAll("rect").data(n,function(t,e){return t.key});c.exit().each(function(t,e){return t._removing=true});c.exit().transition().delay(150).remove();f=c.enter().append("rect");if(w==="column"){f.attr("width",function(t,e){var i;return(i=m.x.bandwidth()-2)>1?i:1})}if(w==="column"){f.attr("y",function(t,e){return m.y(0)})}if(w!=="column"){f.attr("height",function(t,e){var i;return(i=m.y.bandwidth()-2)>1?i:1})}if(w!=="column"){f.attr("x",function(t,e){return m.x(0)})}d=N.select(this).selectAll("rect").transition().duration(350).call(function(t){var e;if(b.multiple!=="group"){return}e=t;if(w==="column"){e.attr("x",function(t,e){return M/2+t.order*(m.x.bandwidth()-M)/n.length})}if(w==="column"){e.attr("width",function(t,e){return(m.x.bandwidth()-M)/n.length})}if(w==="column"){e.attr("y",function(t,e){return Math.round(Math.min(m.y(0),m.y(t.size)))})}if(w!=="column"){e.attr("y",function(t,e){return M/2+t.order*(m.y.bandwidth()-M)/n.length})}if(w!=="column"){e.attr("height",function(t,e){return(m.y.bandwidth()-M)/n.length})}if(w!=="column"){e.attr("x",function(t,e){return Math.round(Math.min(m.x(0),m.x(t.size)))})}return e}).call(function(t){var e;if(b.multiple!=="stack"){return}e=t;if(w==="column"){e.attr("x",M/2)}if(w==="column"){e.attr("width",function(t,e){return m.x.bandwidth()-M})}if(w==="column"){e.attr("y",function(t,e){if(t._removing){return m.y(t.offset+t.size/2)}return Math.round(Math.min(m.y(t.offset),m.y(t.offset+t.size)))})}if(w!=="column"){e.attr("y",M/2)}if(w!=="column"){e.attr("height",function(t,e){return m.y.bandwidth()-M})}if(w!=="column"){e.attr("x",function(t,e){if(t._removing){return m.x(t.offset+t.size/2)}return Math.round(Math.min(m.x(t.offset),m.x(t.offset+t.size)))})}return e});if(w==="column"){d.attr("height",function(t,e){if(t._removing){return 0}else{return Math.round(Math.abs(m.y(0)-m.y(t.size)))}})}else{d.attr("width",function(t,e){if(t._removing){return 0}else{return Math.round(Math.abs(m.x(0)-m.x(t.size)))}})}return d.attr("fill",function(t,e){return v.get(e,b.colorVariant?i/z.length-.5:0)}).attr("fill-opacity",function(t,e){var i,n;if(!(g.name&&(i=g.name.filter))){return 1}if(!(n=i.value)){return 1}if(in$(s.name,n)){return 1}else{return.2}})});if(this.cfg.brush.enabled){this.g.brush.style.display="block";this.g.brush.call(this.brush)}else{this.g.brush.style.display="none"}this.g.brush.selectAll("rect.selection").attr("shape-rendering","auto");this.legend.render();this.yaxis.render();return this.xaxis.render()},tick:function(){}}};function import$(t,e){var i={}.hasOwnProperty;for(var n in e)if(i.call(e,n))t[n]=e[n];return t}function in$(t,e){var i=-1,n=e.length>>>0;while(++i<n)if(t===e[i])return true;return false}</script></div>