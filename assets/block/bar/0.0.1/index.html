<div><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="yaxis">&nbsp;</div><div class="pdl-cell" data-name="view"></div><div class="pdl-cell"></div><div class="pdl-cell" data-name="xaxis">&nbsp;</div><div class="pdl-cell" data-name="legend">&nbsp;</div></div><div data-type="render"></div></div></div><style type="text/css">[data-name=xaxis]{font-size:.8em}[data-name=yaxis]{font-size:.8em}.pdl-layout>div[data-type=layout]{display:grid;grid-template-columns:fit-content(2em) 1fr fit-content(10em);grid-template-rows:1fr fit-content(1em);padding:0 .5em}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=legend]{grid-column:3;grid-row:1/span 2;padding-left:1em}.pdl-layout.legend-below>div[data-type=layout]{grid-template-columns:2em 1fr;grid-template-rows:1fr fit-content(2em) fit-content(3em)}.pdl-layout.legend-below>div[data-type=layout] .pdl-cell[data-name=legend]{padding-top:1em;grid-column:1/span 2;grid-row:3}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"bar",version:"0.0.1",extend:{name:"base",version:"0.0.1"},dependencies:[],i18n:{"zh-TW":{size:"長度"}}},init:function(t){var i,e,n,a;i=t.root,e=t.context,n=t.t,a=t.pubsub;return a.fire("init",{mod:mod({context:e,t:n})})}};mod=function(t){var i,e,n,k,a,s;i=t.context,e=t.t;n=i.chart,k=i.d3,a=i.debounce;return{sample:function(){return{raw:[0,1,2,3,4,5,6,7,8,9,10].map(function(t){var i,e,n;i={name:t};for(e=1;e<=4;++e){n=e;i["val"+n]=Math.random()}return i}),binding:{size:[1,2,3,4].map(function(t){return{key:"val"+t,unit:"amount"}}),name:{key:"name"}}}},config:(s=import$({},n.utils.config.preset["default"]),s.sort={enabled:{type:"boolean"},dir:{type:"choice",values:["asc","desc","none"]}},s.type={type:"choice",values:["bar","column"],default:"column"},s),dimension:{size:{type:"R",multiple:true,name:"size"},name:{type:"NCO",name:"name"}},init:function(){var i,t,e,r=this;this.tint=i=new n.utils.tint;[["multiple","stack"],["percent",false],["dancing",true]].map(function(t){var i,e;i=t[0],e=t[1];if(!(r.cfg[i]!=null)){return r.cfg[i]=e}});this.svg.addEventListener("click",function(){if(!r.cfg.dancing||r.cfg.percent){return}r.alignIdx=((r.alignIdx||0)+1)%(r.binding.size.length+1);r.resize();return r.render()});this.brush=k.brushX();this.g=Object.fromEntries(["view","xaxis","yaxis","legend"].map(function(t){return[t,k.select(r.layout.getGroup(t))]}));this.range="null";t=a(150,function(t){var i,n,e,a,s;if(((i=r.cfg).brush||(i.brush={})).enabled!=null&&!r.cfg.brush.enabled){return}n=t.selection;if((e=JSON.stringify(n))===r.range){return}else{r.range=e}if(!n){return r.filter({name:undefined},true)}else{a=r.scale.x.domain();s=r.scale.x.bandwidth();n=n.map(function(t){var i,e,n;return(i=(n=Math.floor(t/s))>0?n:0)<(e=a.length-1)?i:e});n=function(){var t,i,e=[];for(t=n[0],i=n[1];t<=i;++t){e.push(t)}return e}().map(function(t){return a[t]});return r.filter({name:{type:"index",value:n}},true)}});this.brush.on("end",t);this.brush.on("brush",t);this.scale=e={};this.yaxis=new n.utils.axis({layout:this.layout,name:"yaxis",direction:"left"});this.xaxis=new n.utils.axis({layout:this.layout,name:"xaxis",direction:"bottom"});return this.legend=new n.utils.legend({layout:this.layout,name:"legend",root:this.root,shape:function(t){return k.select(this).attr("fill",i.get(t.key))}})},destroy:function(){if(this.tip){return this.tip.destroy()}},filter:function(t,i){var e=this;i==null&&(i=false);this.render();if(i){return}return this.brush.move(this.g.view,t.name?t.name.map(function(t){return e.scale.x(t)}):null)},parse:function(){this.data.map(function(t){return t.size=t.size.map(function(t){if(isNaN(t)){return 0}else{return t}})});return this.alignIdx=undefined},resize:function(){var a,t,i,e,n,s,r,u,h,c,l,o,f,d,g,m=this;this.type=this.cfg.type||"column";this.legend.config(this.cfg.legend);this.legend.update();this.layout.update(false);this.maxPerGroup=this.binding.size.map(function(t,i){return Math.max.apply(Math,m.data.map(function(t){return t.size[i]}))});if(this.cfg.alignIdx&&!this.alignIdx){this.alignIdx=this.cfg.alignIdx}a=(t=this.cfg.percent?0:this.alignIdx||0)<(i=this.binding.size.length)?t:i;this.baseOffset=this.data.map(function(e){return function(){var t,i,e=[];for(t=0,i=a;t<i;++t){e.push(t)}return e}().reduce(function(t,i){return t+e.size[i]},0)||0});this.delta=e=Math.max.apply(Math,this.baseOffset);if(this.cfg.multiple==="stack"){if(this.cfg.percent){n=1}else{n=Math.max.apply(Math,this.data.map(function(n){return function(){var t,i,e=[];for(t=a,i=n.size.length;t<i;++t){e.push(t)}return e}().reduce(function(t,i){return t+n.size[i]},0)}))+(e||0)}}else if(this.cfg.multiple==="group"){n=Math.max.apply(Math,this.data.map(function(t){return Math.max.apply(Math,t.size)}))}else if(this.cfg.multiple==="split"){n=this.maxPerGroup.reduce(function(t,i){return t+i},0)}this.order=this.data.map(function(t,i){return{key:t._idx,idx:i,name:t.name}});this.data.map(function(t,i){return t.sum=t.size.reduce(function(t,i){return t+i},0)});if(((t=this.cfg).sort||(t.sort={})).enabled){this.order.sort(function(t,i){return(m.cfg.sort.dir==="asc"?1:-1)*(m.data[t.idx].sum-m.data[i.idx].sum)})}if(this.cfg.palette){this.tint.set(this.cfg.palette.colors.map(function(t){return t.value||t}))}this.legend.data(function(){var t,i=[];for(t=this.binding.size.length-1;t>=0;--t){s=t;i.push({key:s,text:this.binding.size[s].name||this.binding.size[s].key})}return i}.call(this));this.layout.update(false);r=this.layout.getBox("view");if(this.type==="column"){t=this.scale;t.y=k.scaleLinear().domain([0,n]).range([r.height,0]);t.x=k.scaleBand().domain(this.order.map(function(t){return t.name||t.key})).range([0,r.width]);u=(t=Math.ceil(this.layout.getBox("yaxis").height/40))>2?t:2;h=this.cfg.bump?function(){var t,i,e,n=[];for(t=1,i=(e=this.parsed.length||1)>1?e:1;t<=i;++t){n.push(t)}return n}.call(this):this.scale.y.ticks((t=((i=this.cfg).yaxis||(i.yaxis={})).tickCount||4)<u?t:u);this.yaxis.config(this.cfg.yaxis);c=this.binding.size[0]||{};if(this.binding.size.length>1){this.yaxis.caption(c.unit?c.unit+"":"")}else{this.yaxis.caption((c.name||c.key||"")+(c.unit?"("+c.unit+")":""))}this.yaxis.ticks(h);this.yaxis.scale(this.scale.y);this.xaxis.config((t=this.cfg).xaxis||(t.xaxis={}));this.xaxis.ticks(this.data.map(function(t){return t.name}));this.xaxis.scale(this.scale.x);this.xaxis.caption((this.binding.name.name||this.binding.name.key)+(this.binding.name.unit?"("+this.binding.name.unit+")":""))}else{t=this.scale;t.x=k.scaleLinear().domain([0,n]).range([r.width,0]);t.y=k.scaleBand().domain(this.order.map(function(t){return t.name||t.key})).range([0,r.height]);u=(t=Math.ceil(this.layout.getBox("xaxis").width/80))>2?t:2;l=this.cfg.bump?function(){var t,i,e,n=[];for(t=1,i=(e=this.parsed.length||1)>1?e:1;t<=i;++t){n.push(t)}return n}.call(this):this.scale.x.ticks((t=((i=this.cfg).xaxis||(i.xaxis={})).tickCount||4)<u?t:u);this.xaxis.config(this.cfg.xaxis);c=this.binding.size[0]||{};if(this.binding.size.length>1){this.xaxis.caption(c.unit?c.unit+"":"")}else{this.xaxis.caption((c.name||c.key||"")+(c.unit?"("+c.unit+")":""))}this.xaxis.ticks(l);this.xaxis.scale(this.scale.x);this.yaxis.config((t=this.cfg).yaxis||(t.yaxis={}));this.yaxis.ticks(this.data.map(function(t){return t.name}));this.yaxis.scale(this.scale.y);this.yaxis.caption((this.binding.name.name||this.binding.name.key)+(this.binding.name.unit?"("+this.binding.name.unit+")":""))}for(o=0;o<2;++o){s=o;this.layout.update(false);r=this.layout.getBox("view");t=[r.width,r.height],f=t[0],d=t[1];this.tint.set(this.cfg.palette);g=this.cfg.dotSize||3;this.scale.x.range([0,f-g]);this.scale.y.range([d,g]);this.xaxis.render();this.yaxis.render()}r=this.layout.getBox("view");return this.brush.extent([[0,1],[r.width,r.height-1]])},render:function(){var g,m,t,x,p,y,b,v,z,w,i,e,n=this;g=this.binding,m=this.scale,t=this.range,x=this.delta,p=this.baseOffset,y=this.maxPerGroup,b=this.cfg,v=this.tint,z=this.data,w=this.type;i=this.g.view.selectAll("g.bar").data(this.data);i.exit().remove();i.enter().append("g").attr("class","bar");this.g.view.selectAll("g.bar").attr("transform",function(t,i){if(n.type==="column"){return"translate("+m.x(t.name)+",0)"}else{return"translate(0,"+m.y(t.name)+")"}}).each(function(a,e){var t,n,i,s,r,u,h,c,l,o,f,d;t=[[],0],n=t[0],i=t[1];i=x-p[e];s=1;if(b.percent===true){s=(t=a.size.reduce(function(t,i){return t+i},0))>1?t:1}for(r=0,u=a.size.length;r<u;++r){h=r;c=a.size[h];l=h;n.push({size:c/s,offset:i/s,key:l,group:a.name,name:g.size[l].name||g.size[l].key,unit:g.size[l].unit||""});if(b.multiple==="split"){i+=y[h]}else if(b.multiple==="stack"){i+=c}}o=k.select(this).selectAll("rect").data(n,function(t,i){return t.key});o.exit().remove();f=o.enter().append("rect");if(w==="column"){f.attr("width",function(t,i){var e;return(e=m.x.bandwidth()-2)>1?e:1})}if(w==="column"){f.attr("y",function(t,i){return m.y(0)})}if(w!=="column"){f.attr("height",function(t,i){var e;return(e=m.y.bandwidth()-2)>1?e:1})}if(w!=="column"){f.attr("x",function(t,i){return m.x(0)})}d=k.select(this).selectAll("rect").transition().duration(350).call(function(t){var i;if(b.multiple!=="group"){return}i=t;if(w==="column"){i.attr("x",function(t,i){return 1+i*(m.x.bandwidth()-2)/n.length})}if(w==="column"){i.attr("width",function(t,i){return(m.x.bandwidth()-2)/n.length})}if(w==="column"){i.attr("y",function(t,i){return Math.round(Math.min(m.y(0),m.y(t.size)))})}if(w!=="column"){i.attr("y",function(t,i){return 1+i*(m.y.bandwidth()-2)/n.length})}if(w!=="column"){i.attr("height",function(t,i){return(m.y.bandwidth()-2)/n.length})}if(w!=="column"){i.attr("x",function(t,i){return Math.round(Math.min(m.x(0),m.x(t.size)))})}return i}).call(function(t){var i;if(b.multiple!=="stack"){return}i=t;if(w==="column"){i.attr("x",1)}if(w==="column"){i.attr("width",function(t,i){return m.x.bandwidth()-2})}if(w==="column"){i.attr("y",function(t,i){return Math.round(Math.min(m.y(t.offset),m.y(t.offset+t.size)))})}if(w!=="column"){i.attr("y",1)}if(w!=="column"){i.attr("height",function(t,i){return m.y.bandwidth()-2})}if(w!=="column"){i.attr("x",function(t,i){return Math.round(Math.min(m.x(t.offset),m.x(t.offset+t.size)))})}return i});if(w==="column"){d.attr("height",function(t,i){return Math.round(Math.abs(m.y(0)-m.y(t.size)))})}else{d.attr("width",function(t,i){return Math.round(Math.abs(m.x(0)-m.x(t.size)))})}return d.attr("fill",function(t,i){return v.get(i,b.colorVariant?e/z.length-.5:0)}).attr("fill-opacity",function(t,i){var e,n;if(!(g.name&&(e=g.name.filter))){return 1}if(!(n=e.value)){return 1}if(in$(a.name,n)){return 1}else{return.2}})});if(!(((e=this.cfg).brush||(e.brush={})).enabled!=null&&!this.cfg.brush.enabled)){this.g.view.call(this.brush)}this.g.view.selectAll("rect.selection").attr("shape-rendering","auto");this.legend.render();this.yaxis.render();return this.xaxis.render()},tick:function(){}}};function import$(t,i){var e={}.hasOwnProperty;for(var n in i)if(e.call(i,n))t[n]=i[n];return t}function in$(t,i){var e=-1,n=i.length>>>0;while(++e<n)if(t===i[e])return true;return false}</script></div>