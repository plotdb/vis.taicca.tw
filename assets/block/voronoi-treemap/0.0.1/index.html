<div><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="view"></div><div class="pdl-cell" data-name="legend"></div></div><div data-type="render"></div></div></div><style type="text/css">.pdl-layout>div[data-type=layout]{display:grid;grid-template-columns:1fr fit-content(10em)}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=view]{grid-column:1}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=legend]{grid-column:2;padding:0 .5em 0 .5em}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"voronoi-treemap",version:"0.0.1",extend:{name:"base",version:"0.0.1"},dependencies:[{name:"@zbryikt/voronoijs",version:"main",path:"index.min.js"}]},init:function(t){var e,n,i;e=t.root,n=t.context,i=t.pubsub;return i.fire("init",{mod:mod({context:n})}).then(function(t){return t[0]})}};mod=function(t){var e,u,l,h,n;e=t.context;u=e.d3,l=e.ldcolor,h=e.voronoi,n=e.chart;return{sample:function(){return{raw:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100].map(function(t){return{val:Math.random()*10,cat:Math.floor(1+10*Math.random()),name:t}}),binding:{name:{key:"name"},area:{key:"val"},category:{key:"cat"}}}},config:{},dimension:{area:{type:"R",name:"area"},name:{type:"N",desc:"name"},category:{type:"N",desc:"category"}},init:function(){var e,t,i=this;this.tint=e=new n.utils.tint;this.g=Object.fromEntries(["view","legend"].map(function(t){return[t,u.select(i.layout.getGroup(t))]}));this.layout.getGroup("view").appendChild(t=document.createElementNS("http://www.w3.org/2000/svg","g"));this.g.shape=u.select(t);this.siteBoxes=[];this.legend=new n.utils.legend({layout:this.layout,name:"legend",root:this.root,shape:function(t){return u.select(this).attr("fill",e.get(t.key))},cfg:{selectable:true}});this.legend.on("select",function(){i.bind();i.resize();return i.render()});this.tip=new n.utils.tip({root:this.root,accessor:function(t){var e,n;e=t.evt;if(!(e.target&&(n=u.select(e.target).datum()))){return null}if(Array.isArray(n)){if(!i._sites){return}if(!(n.idx!=null)){return}if(!(n=i._sites[n.idx])){return}}return{name:n.name,value:n.area.toFixed(2)+""+(i.binding.area.unit||"")}},range:function(){return i.layout.getNode("view").getBoundingClientRect()}});return this.start()},parse:function(){this.data.map(function(t){return t.key=t.name,t.value=t.area,t});this.total=this.data.reduce(function(t,e){return t+e.area},0);this.cats=Array.from(new Set(this.data.map(function(t){return t.category})));return this.legend.data(this.cats.map(function(t){return{key:t,text:t}}))},bind:function(){var t,e,n,i,r,a,s,o,l=this;t=this.data.filter(function(t){return l.legend.isSelected(t.category)});this.parsed={children:u.nest().key(function(t){return t.category}).entries(t).map(function(t){return t.children=t.values,t})};e=this.box||this.svg.getBoundingClientRect();n=[e.width,e.height],i=n[0],r=n[1];i=r=Math.min(i,r);this.treemap=new h.Treemap(this.parsed,h.Polygon.create(i,r,60),i,r);a=this.treemap.getSites();s=this.g.shape.selectAll("path.data").data(this.treemap.getPolygons());s.exit().remove();s.enter().append("path").attr("class","data").each(function(t,e){return t.idx=e});this.g.shape.selectAll("path.data").attr("class",function(t,e){if(a[e].lv<=0){return"data group"}else{return"data"}});this.polygons=this.g.shape.selectAll("path.data");o=this.g.shape.selectAll("g.label").data(a);o.exit().remove();o.enter().append("g").attr("class","label").each(function(t,e){var n;n=u.select(this);n.append("text").attr("class","name").attr("font-size",".8em");n.append("text").attr("class","value");return n});this.sites=this.g.shape.selectAll("g.label");return this.sites.each(function(t,e){return u.select(this).selectAll("text").data([t,t]).attr("text-anchor","middle").attr("dominant-baseline","center")})},resize:function(){var t,e,n,i,r,a;t=this.layout.getBox("view");e=[t.width,t.height],n=e[0],i=e[1];r=Math.min(n,i);this.legend.config(this.cfg.legend);this.legend.update();this.layout.update(false);this.g.shape.attr("transform","translate("+(n/2-r/2)+","+(i/2-r/2)+")");this.scale={x:u.scaleLinear().domain([0,n]).range([0,n]),y:u.scaleLinear().domain([0,i]).range([0,i]),color:u.interpolateTurbo};if(this.cfg!=null&&this.cfg.palette){this.scale.color=u.interpolateDiscrete(this.cfg.palette.colors.map(function(t){return l.web(t.value||t)}))}this.tint.set(this.cfg.palette);a=this.treemap.getSites();this.count=0;return this.gbox=this.svg.getBoundingClientRect()},render:function(t){var n,e,i,r,a,s,c,o=this;t==null&&(t=false);this._sites=n=this.treemap.getSites();e=this.treemap.getPolygons();i=[this.box.width,this.box.height],r=i[0],a=i[1];if(!t){this.legend.render();this.sites.selectAll(".name").attr("dy","0.88em").text(function(t){var e;e=(t.name||"")+"";return e;if(t.lv>0){return e.substring(0,7)+(e.length>7?"...":"")}else{return""}}).attr("fill",function(t,e){if(l.hcl(o.tint.get(t.category)).l>60){return"#000"}else{return"#eee"}}).style("pointer-events","none");this.sites.selectAll(".value").attr("dy","-0.28em").text(function(t){if(t.lv>0){return(t.area||0).toFixed(2)}else{return""}}).attr("fill",function(t,e){if(l.hcl(o.tint.get(t.category)).l>60){return"#000"}else{return"#eee"}}).style("pointer-events","none");this.siteBoxes=s=[];this.sites.each(function(t,e){return s.push(this.getBoundingClientRect())});this.polygons.attr("fill",function(t,e){return o.tint.get(n[e].category)}).attr("stroke","#fff").attr("stroke-width",1)}s=this.siteBoxes;c=[];this.polygons.data(e).attr("d",function(t,e){var n,i,r,a,s,o,l,u,h;t.idx=e;if(!(t&&t.length)){c.push({});return""}n=[["M",t[0].x,t[0].y]];i=[{x:t[0].x,y:t[0].y},{x:t[0].x,y:t[0].y}],r=i[0],a=i[1];for(s=0,o=t.length;s<o;++s){l=s;i=[t[l].x,t[l].y],u=i[0],h=i[1];if(r.x>u){r.x=u}if(a.x<u){a.x=u}if(r.y>h){r.y=h}if(a.y<h){a.y=h}n.push(["L",u,h])}n.push(["L",t[0].x,t[0].y]);c.push({x:r.x,y:r.y,width:a.x-r.x,height:a.y-r.y});return n.map(function(t){return t.join(" ")}).join(" ")});return this.sites.each(function(t,e){var i,r;i=c[e];r=s[e];if(!r){r=this.getBoundingClientRect()}return u.select(this).attr("transform",function(){var t,e;t=i.x+i.width/2;e=i.y+i.height/2;if(isNaN(t)){t=-1e4}if(isNaN(e)){e=-1e4}return"translate("+t+", "+e+")"}).attr("opacity",function(){var t,e,n;return(t=1-6*((e=r.width/((n=i.width)>0?n:0)-1)>0?e:0))>0?t:0})})},tick:function(){this.count=(this.count||0)+1;if(this.count<100){this.treemap.compute();return this.render(true)}}}};</script></div>