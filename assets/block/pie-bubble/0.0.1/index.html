<div><script type="@plotdb/block">(function(it){
  return it();
})(function(){
  var blockFactory, mod;
  blockFactory = {
    pkg: {
      name: 'pie-bubble',
      version: '0.0.1',
      extend: {
        name: "base",
        version: "0.0.1"
      },
      dependencies: []
    },
    init: function(arg$){
      var root, context, pubsub;
      root = arg$.root, context = arg$.context, pubsub = arg$.pubsub;
      return pubsub.fire('init', {
        mod: mod({
          context: context
        })
      }).then(function(it){
        return it[0];
      });
    }
  };
  mod = function(arg$){
    var context, d3, forceBoundary, ldColor, repeatString$, pdmapWorld, topojson;
    context = arg$.context;
    d3 = context.d3, forceBoundary = context.forceBoundary, ldColor = context.ldColor, repeatString$ = context.repeatString$, pdmapWorld = context.pdmapWorld, topojson = context.topojson;
    return {
      sample: function(){
        return {
          raw: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100].map(function(val){
            return {
              val1: Math.random() * 100,
              val2: Math.random() * 100
            };
          }),
          binding: {
            size1: {
              key: 'val1'
            },
            size2: {
              key: 'val2'
            }
          }
        };
      },
      config: {},
      dimension: {
        size1: {
          type: 'R',
          name: "大小1"
        },
        size2: {
          type: 'R',
          name: "大小2"
        }
      },
      init: function(){},
      resize: function(){
        var rng, this$ = this;
        rng = d3.randomUniform.source(d3.randomLcg(this.seed))(0, 1);
        this.data.map(function(v){
          var x, y, r, c, c1, c2, val, ref$, v1, v2, rate;
          x = rng() * this$.box.width * 0.8 + this$.box.width * 0.1;
          y = rng() * this$.box.height * 0.8 + this$.box.height * 0.1;
          r = v.size1 + v.size2;
          c = v.size1;
          c1 = v.size1;
          c2 = v.size2;
          val = r;
          ref$ = [(ref$ = v.size1) > 0 ? ref$ : 0, (ref$ = v.size2) > 0 ? ref$ : 0], v1 = ref$[0], v2 = ref$[1];
          rate = !(v1 + v2)
            ? 0.5
            : v2 / (v1 + v2);
          x = rate * this$.box.width;
          return v.x = x, v.y = y, v.c = c, v.c1 = c1, v.c2 = c2, v.r = r, v.val = val, v.size1 = v1, v.size2 = v2, v.rate = rate, v;
        });
        return this.area = this.box.width * this.box.height;
      },
      render: function(){
        var rate, scale, x$, y$, z$, this$ = this;
        this.rate = rate = 0.95 * this.area / this.data.map(function(it){
          return Math.PI * Math.pow(it.r, 2);
        }).reduce(function(a, b){
          return a + b;
        }, 0);
        this.rate = rate = 0.2;
        this.scale = scale = {
          color: d3.interpolateTurbo,
          r: d3.scaleLinear().domain([0, 100]).range([0, 1])
        };
        if (this.cfg != null && this.cfg.pal) {
          this.scale.color = d3.interpolateDiscrete(this.cfg.pal.colors.map(function(it){
            return ldColor.web(it.value || it);
          }));
        }
        x$ = d3.select(this.svg).selectAll('circle.bubble').data(this.data);
        x$.exit().remove();
        x$.enter().append('circle').attr('class', 'bubble').attr('r', function(d, i){
          return 0;
        }).attr('fill', function(d, i){
          return this$.scale.color(this$.scale.r(d.c));
        });
        d3.select(this.svg).selectAll('circle.bubble').attr('opacity', '0.0').attr('cx', function(d, i){
          return d.x;
        }).attr('cy', function(d, i){
          return d.y;
        }).transition().duration(350).attr('fill', function(d, i){
          return this$.scale.color(this$.scale.r(d.c));
        }).attr('r', function(d, i){
          var ref$;
          return ((ref$ = d.r) > 2 ? ref$ : 2) * this$.rate;
        });
        y$ = d3.select(this.svg).selectAll('g.label').data(this.data);
        y$.exit().remove();
        y$.enter().append('g').attr('class', 'label').each(function(d, i){
          var this$ = this;
          return [0, 1].map(function(){
            return d3.select(this$).append('text');
          }).map(function(it){
            return it.attr('dy', '-.28em').attr('text-anchor', 'middle').attr('font-size', '.7em').attr('font-family', 'Rubik').style('pointer-event', 'none');
          });
        });
        d3.select(this.svg).selectAll('g.label').attr('transform', function(d, i){
          return "translate(" + d.x + "," + d.y + ")";
        }).each(function(d, i){
          return d3.select(this).selectAll('text').attr('opacity', d.r * 2 * rate < (d.val.toFixed(2) + "").length * 7 ? 0 : 1).attr('dy', function(e, i){
            return '.38em';
          }).text(function(e, i){
            if (i === 0) {
              if (d.val > 1000000) {
                return (d.val / 1000000).toFixed(2) + "M";
              } else if (d.val > 1000) {
                return (d.val / 1000).toFixed(2) + "K";
              } else {
                return d.val.toFixed(2);
              }
            } else {
              return d._idx;
            }
          });
        });
        z$ = d3.select(this.svg).selectAll('g.pie').data(this.data);
        z$.exit().remove();
        z$.enter().append('g').attr('class', 'pie').each(function(){
          d3.select(this).append('path');
          return d3.select(this).append('path');
        });
        return d3.select(this.svg).selectAll('g.pie').each(function(d, i){
          d3.select(this).attr('transform', "translate(" + d.x + " " + d.y + ")");
          return d3.select(this).selectAll('path').attr('fill', function(e, j){
            return scale.color(j);
          }).attr('d', function(e, j){
            var r, ref$, rx, ry1, ry2, f;
            r = ((ref$ = d.r) > 2 ? ref$ : 2) * rate;
            rx = r * Math.cos(d.rate * Math.PI);
            ry1 = -r * Math.sin(d.rate * Math.PI);
            ry2 = r * Math.sin(d.rate * Math.PI);
            f = d.size1 < d.size2
              ? j
              : 1 - j;
            return ["M", rx, ry1, "A", r, r, 0, f, j, rx, ry2, "L", 0, 0, "Z"].join(" ");
          });
        });
      },
      tick: function(){
        var kickoff, fc, alpha, this$ = this;
        if (!this.sim) {
          kickoff = true;
          this.fc = fc = d3.forceCollide();
          this.sim = d3.forceSimulation().force('center', this.fg = d3.forceCenter(this.box.width / 2, this.box.height / 2)).force('x', this.fx = d3.forceX(this.box.width / 2).strength(0.1)).force('y', this.fy = d3.forceY((this.box.height - 40) / 2).strength(0.1)).force('b', this.fb = forceBoundary(function(it){
            return it.r;
          }, function(it){
            return it.r;
          }, function(it){
            return this$.box.width - it.r;
          }, function(it){
            return this$.box.height - it.r;
          })).force('collide', fc);
          this.sim.stop();
          this.sim.alpha(0.9);
        }
        this.sim.nodes(this.data);
        this.fc.strength(1.2);
        this.fc.radius(function(it){
          return this$.rate * it.r * 1.02 + 2;
        });
        this.fg.x(this.box.width / 2);
        this.fg.y(this.box.height / 2);
        this.fx.strength(0.01);
        this.fy.strength(0.01);
        this.sim.tick(kickoff ? 10 : 1);
        alpha = this.sim.alpha();
        d3.select(this.svg).selectAll('circle.bubble').attr('cx', function(d, i){
          return d.x;
        }).attr('cy', function(d, i){
          return d.y;
        });
        d3.select(this.svg).selectAll('g.label').attr('transform', function(d, i){
          return "translate(" + d.x + "," + d.y + ")";
        });
        return d3.select(this.svg).selectAll('g.pie').attr('transform', function(d, i){
          return "translate(" + d.x + "," + d.y + ")";
        });
      }
    };
  };
  return blockFactory;
});</script></div>